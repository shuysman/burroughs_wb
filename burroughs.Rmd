---
title: 'Burroughs Creek WBP Planting Unit Microsites'
author: "Stephen Huysman"
date: "`r Sys.Date()`"
fontsize: 10pt 
bibliography: library.bib
csl: global-ecology-and-biogeography.csl
output:
  html_document:
    toc: false
    toc_float: false
---

```{css, echo=FALSE}
body .main-container {
    max-width: 1600px !important;
    width: 1080px !important;
}
body {
    max-width: 1600px !important;
}
```

``` {r setup, include = FALSE}
library(tidyverse)
library(sf)
library(terra)
library(tidyterra)
library(ggnewscale)
library(ggspatial)
library(ggpubr)
library(kableExtra)

terraOptions(verbose = TRUE,
             memfrac = 0.9)

elev <- rast("./data/burroughs_creek_USGS1m_clipped_nad83.tif") 
aspect <- rast("./data/planting_unit_aspect.tif")
slope <- rast("./data/planting_unit_slope.tif")
shade <- rast("./data/burroughs_creek_USGS1m_clipped_hillshade_nad83.tif")
soil <- rast("./data/soil_whc_025_aligned_clipped.tif") %>% round(2) %>% clamp(lower = 0, values = NA)

pal_greys <- hcl.colors(1000, "Grays")

units <- st_read("./data/units/Possible_WBP_Units_Nancy_Updated.shp") %>% st_cast("MULTIPOLYGON") %>%
    bind_cols(data.frame(elev_mean = zonal(elev, vect(units), fun = "mean")[[1]],
                         elev_max = zonal(elev, vect(units), fun = "max")[[1]],
                         elev_min = zonal(elev, vect(units), fun = "min")[[1]],
                         slope_mean = zonal(slope, vect(units), fun = "mean", na.rm = TRUE)[[1]],
                         slope_max = zonal(slope, vect(units), fun = "max", na.rm = TRUE)[[1]],
                         slope_min = zonal(slope, vect(units), fun = "min", na.rm = TRUE)[[1]],
                         aspect_mean = zonal(aspect, vect(units), fun = "mean", na.rm = TRUE)[[1]]
                         ))
```

# Introduction

`r crs(elev, proj = TRUE)`

`r st_bbox(elev)`

## Planting Units

```{r planting-units, fig.height = 8, fig.width = 10, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
knitr::kable(select(as_tibble(units),
                    Unit,
                    Description = DESCRIPTIO,
                    Acres = ACRES,
                    elev_mean,
                    elev_max,
                    elev_min,
                    slope_mean,
                    slope_max,
                    slope_min,
                    aspect_mean),
             digits = 2)

ggplot() +
    geom_spatraster(data = shade, show.legend = FALSE) +
##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "Burroughs WBP Planting Units Hillshade") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
```


##  Soils
``` {r soils, fig.height = 8, fig.width = 10, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
ggplot() +
    geom_spatraster(data = soil) +
    labs(title = "Burroughs WBP Planting Unit Soil WHC (mm) to 25cm soil depth") +
    scale_fill_viridis_b() +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
```

Soils range from `r global(soil, min, na.rm = TRUE)[[1]]` to `r global(soil, max, na.rm = TRUE)[[1]]` mm whc at 25 cm soil depth. Soil water capacity at 25 cm was selected because the application of this report is for planting seedlings and mature whitebark pine trees typically have shallow root systems not typically penetrating more than 30cm of soil (https://www.fs.usda.gov/database/feis/plants/tree/pinalb/all.html).

``` {r soils-zonals, echo = FALSE}
zonal(soil, vect(units), fun = "mean", na.rm = TRUE) %>%
    cbind(Unit = units$Unit, .) %>%
    knitr::kable(digits = 2, col.names = c("Unit", "Mean Soil WHC (mm)")) %>%
    kable_styling(full_width = F)
```


## T50

``` {r include = FALSE}
t50 <- global(rast("./data/jennings_t50_coefficients.tif"), "mean")[[1]]
```

Jennings *T*~50~ coeffcient used for all cells = `r t50`

# Methods
## Analysis
1. Prepare layers
Everything projected, resampled, and cropped using 1m LiDAR DEM as Reference
- DEM
1m LiDAR opentopography.org
- resample_layers.R
	dayl
	t50
- slope (GDAL in QGIS)
- aspect (GDAL in QGIS)
- split_ncs.R/split_ncs.sbatch
  Split climate inputs (tmax, tmin, Precip) into tifs, 1 tif per day
  Results in millions of layers for each combo of day/year/gcm/scenario/variable
- Soil
SSURGO data from Curve Number Generator in QGIS
25 cm depth AWC

2. Run WB
start_wb_v_1_5.py

3. Collate
collate.R

4. Annual sums of AET/Deficit
annual_sum.sh using CDO


## Grids
### 4km (gridMET/MACA scale)
- t
- p
- accumswe
### 1m (DEM scale)
- Elevation (1m lidar)
- Slope (1m lidar derived)
- Aspect (1m lidar derived)

### Other/TBD
- soil (1:24000 ssurgo)
- dayl (1 km daymet, I think)
- t50 (4km? see jennings file)

# Results

## Historical

``` {r historical, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 16, out.width = '100%'}
gridmet_data_dir <- file.path("~/out/sums/")

aet <- rast(file.path(gridmet_data_dir, "historical_gridmet_AET_annual_sum_burroughs.nc")) |>
    clamp(lower = 0, values = NA) / 10
cwd <- rast(file.path(gridmet_data_dir, "historical_gridmet_Deficit_annual_sum_burroughs.nc")) |>
    clamp(lower = 0, values = NA) / 10


### 1988 Drought Year
aet_1988 <- aet %>% subset(year(time(.)) == 1988)
cwd_1988 <- cwd %>% subset(year(time(.)) == 1988)

### Previous 20 years before current
aet_mean_2002 <- aet %>% subset(year(time(.)) >= 1982 & year(time(.)) <= 2002) %>% mean()
cwd_mean_2002 <- cwd %>% subset(year(time(.)) >= 1982 & year(time(.)) <= 2002) %>% mean()

### Last 20 years
aet_mean_2022 <- aet %>% subset(year(time(.)) >= 2002 & year(time(.)) <= 2022) %>% mean()
cwd_mean_2022 <- cwd %>% subset(year(time(.)) >= 2002 & year(time(.)) <= 2022) %>% mean()

unit_stats <- as_tibble(units) %>% bind_cols(
                                       aet_1988 = zonal(aet_1988, vect(units), fun = "mean", na.rm = TRUE)[[1]],
                                       cwd_1988 = zonal(cwd_1988, vect(units), fun = "mean", na.rm = TRUE)[[1]],
                                       aet_2002 = zonal(aet_mean_2002, vect(units), fun = "mean", na.rm = TRUE)[[1]],
                                       cwd_2002 = zonal(cwd_mean_2002, vect(units), fun = "mean", na.rm = TRUE)[[1]],
                                       aet_2022 = zonal(aet_mean_2022, vect(units), fun = "mean", na.rm = TRUE)[[1]],
                                       cwd_2022 = zonal(cwd_mean_2022, vect(units), fun = "mean", na.rm = TRUE)[[1]]
                                   )

knitr::kable(select(unit_stats,
                    Unit, DESCRIPTIO, aet_1988:cwd_2022),
             digits = 2)


aet_scale <-
    scale_fill_viridis_c(option = "D", limits = c(0,300))

cwd_scale <-
    scale_fill_viridis_c(option = "B", limits = c(0,350))

aet_2002_plot <- ggplot() +
    geom_spatraster(data = aet_mean_2002, alpha = 1) +
    aet_scale + 
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1982-2002 mean annual sum of AET (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_2002_plot <- ggplot() +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data =cwd_mean_2002, alpha = 1) +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1982-2002 mean annual sum of Deficit (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


aet_2022_plot <- ggplot() +
    geom_spatraster(data = aet_mean_2022, alpha = 1) +
    aet_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "2002-2022 mean annual sum of AET (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
##ggsave("burroughs_2002-2022_aet.png", width=16, height=12)


cwd_2022_plot <- ggplot() +
    geom_spatraster(data = cwd_mean_2022, alpha = 1) +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "2002-2022 mean annual sum of Deficit (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
##ggsave("burroughs_2002-2022_deficit.png", width=16, height=12)



aet_1988_plot <- ggplot() +
    geom_spatraster(data = aet_1988, alpha = 1) +
    theme(legend.position="bottom") +
    aet_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1988 AET (Drought Year)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


cwd_1988_plot <- ggplot() +
    geom_spatraster(data = cwd_1988, alpha = 1) +
    theme(legend.position="bottom") +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1988 CWD (Drought Year)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


ggarrange(aet_2002_plot, aet_2022_plot, common.legend = TRUE)
ggarrange(cwd_2002_plot, cwd_2022_plot, common.legend = TRUE)

ggarrange(aet_1988_plot, cwd_1988_plot)


```


``` {r eval = F, include = F}
current <- 2006:2024
near <- 2025:2049
mid <- 2050:2074
end <- 2075:2099

ens_dir <- file.path("/media/smithers/shuysman/data/burroughs/sums/ensembles/")

cwd_ens45 <- rast(file.path(ens_dir, "ensemble_rcp45_Deficit_annual_sum_burroughs.nc")) %>%
    clamp(lower = 0, values = NA) / 10

cwd_ens45_near <- cwd_ens45 %>% subset(year(time(.)) %in% near) %>% mean()
cwd_ens45_mid <- cwd_ens45 %>% subset(year(time(.)) %in% mid) %>% mean()
cwd_ens45_end <- cwd_ens45 %>% subset(year(time(.)) %in% end) %>% mean()

cwd_ens85 <- rast(file.path(ens_dir, "ensemble_rcp85_Deficit_annual_sum_burroughs.nc")) %>%
    clamp(lower = 0, values = NA) / 10

cwd_ens85_near <- cwd_ens85 %>% subset(year(time(.)) %in% near) %>% mean()
cwd_ens85_mid <- cwd_ens85 %>% subset(year(time(.)) %in% mid) %>% mean()
cwd_ens85_end <- cwd_ens85 %>% subset(year(time(.)) %in% end) %>% mean()

aet_ens45 <- rast(file.path(ens_dir, "ensemble_rcp45_AET_annual_sum_burroughs.nc")) %>%
    clamp(lower = 0, values = NA) / 10

aet_ens45_near <- aet_ens45 %>% subset(year(time(.)) %in% near) %>% mean()
aet_ens45_mid <- aet_ens45 %>% subset(year(time(.)) %in% mid) %>% mean()
aet_ens45_end <- aet_ens45 %>% subset(year(time(.)) %in% end) %>% mean()

aet_ens85 <- rast(file.path(ens_dir, "ensemble_rcp85_AET_annual_sum_burroughs.nc")) %>%
    clamp(lower = 0, values = NA) / 10

aet_ens85_near <- aet_ens85 %>% subset(year(time(.)) %in% near) %>% mean()
aet_ens85_mid <- aet_ens85 %>% subset(year(time(.)) %in% mid) %>% mean()
aet_ens85_end <- aet_ens85 %>% subset(year(time(.)) %in% end) %>% mean()


ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_ens45_near, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD, Near-future (2025-2049)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_ens45_mid, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD, Mid-century (2050-2074)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_ens45_end, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD, End-century (2075-2099)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD, End-century (2075-2099)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


cwd_rcp85_change_from_baseline <- cwd_ens85_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp85_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP8.5 Ensemble Mean CWD end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

aet_rcp45_change_from_baseline <- aet_ens45_end - aet_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "G") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean AET end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


aet_rcp85_change_from_baseline <- aet_ens85_end - aet_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = aet_rcp85_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP8.5 Ensemble Mean AET end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


```
