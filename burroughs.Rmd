---
title: 'Burroughs Creek WBP Planting Unit Microsites'
author: "Stephen Huysman"
date: "`r Sys.Date()`"
fontsize: 10pt 
bibliography: library.bib
csl: global-ecology-and-biogeography.csl
output:
  html_document:
    toc: false
    toc_float: false
---

```{css, echo=FALSE}
body .main-container {
    max-width: 1600px !important;
    width: 1080px !important;
}
body {
    max-width: 1600px !important;
}
```


# Planting Units

```{r planting-units, fig.height = 8, fig.width = 10, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
library(tidyverse)
library(sf)
library(terra)
library(tidyterra)
library(ggnewscale)
library(ggspatial)

terraOptions(verbose = TRUE,
             memfrac = 0.9)

elev <- rast("./data/burroughs_creek_USGS1m_clipped_nad83.tif") 
aspect <- rast("./data/planting_unit_aspect.tif")
slope <- rast("./data/planting_unit_slope.tif")
shade <- rast("./data/burroughs_creek_USGS1m_clipped_hillshade_nad83.tif")
soil <- rast("./data/soil_whc_150_aligned_clipped.tif") %>% round(2) %>% clamp(lower = 0, values = NA)

pal_greys <- hcl.colors(1000, "Grays")

units <- st_read("./data/units/Possible_WBP_Units_Nancy_Updated.shp") %>% st_cast("MULTIPOLYGON") %>%
    bind_cols(data.frame(elev_mean = zonal(elev, vect(units), fun = "mean")[[1]],
                         elev_max = zonal(elev, vect(units), fun = "max")[[1]],
                         elev_min = zonal(elev, vect(units), fun = "min")[[1]],
                         slope_mean = zonal(slope, vect(units), fun = "mean", na.rm = TRUE)[[1]],
                         slope_max = zonal(slope, vect(units), fun = "max", na.rm = TRUE)[[1]],
                         slope_min = zonal(slope, vect(units), fun = "min", na.rm = TRUE)[[1]],
                         aspect_mean = zonal(aspect, vect(units), fun = "mean", na.rm = TRUE)[[1]]
                         ))


knitr::kable(select(as_tibble(units),
                    Description = DESCRIPTIO,
                    Unit,
                    Acres = ACRES,
                    elev_mean,
                    elev_max,
                    elev_min,
                    slope_mean,
                    slope_max,
                    slope_min,
                    aspect_mean))

ggplot() +
    geom_spatraster(data = shade, show.legend = FALSE) +
##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "Burroughs WBP Planting Units") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggplot() +
    geom_spatraster(data = soil) +
    labs(title = "Burroughs WBP Planting Unit Soil WHC in cm to 150cm soild depth") +
    scale_fill_viridis_b() +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
```

# Analysis
1. Prepare layers
Everything projected, resampled, and cropped using 1m LiDAR DEM as Reference
- DEM
1m LiDAR opentopography.org
- resample_layers.R
	dayl
	t50
- slope (GDAL in QGIS)
- aspect (GDAL in QGIS)
- split_ncs.R/split_ncs.sbatch
  Split climate inputs (tmax, tmin, Precip) into tifs, 1 tif per day
  Results in millions of layers for each combo of day/year/gcm/scenario/variable
- Soil
SSURGO data from Curve Number Generator in QGIS
150 cm depth AWC

2. Run WB
start_wb_v_1_5.py

3. Collate
collate.R

4. Annual sums of AET/Deficit
annual_sum.sh using CDO


# Grids
## Coarse
### 4km (gridMET/MACA scale)
- t
- p
- accumswe
### 1m (DEM scale)
- Elevation (1m lidar)
- Slope (1m lidar derived)
- Aspect (1m lidar derived)

### Other/TBD
- soil (1:24000 ssurgo)
- dayl (1 km daymet, I think)
- t50 (4km? see jennings file)



``` {r historical, eval = FALSE, include = FALSE}
gridmet_data_dir <- file.path("~/out/")

aet <- rast(file.path(gridmet_data_dir, "historical_gridmet_AET_annual_sum_burroughs.nc")) |>
    clamp(lower = 0, values = NA) / 10
cwd <- rast(file.path(gridmet_data_dir, "historical_gridmet_Deficit_annual_sum_burroughs.nc")) |>
    clamp(lower = 0, values = NA) / 10

aet_1988 <- aet %>% subset(year(time(.)) == 1988)
cwd_1988 <- cwd %>% subset(year(time(.)) == 1988)

aet_mean_2000 <- aet %>% subset(year(time(.)) >= 1980 & year(time(.)) <= 2000) %>% mean()
cwd_mean_2000 <- cwd %>% subset(year(time(.)) >= 1980 & year(time(.)) <= 2000) %>% mean()

animate(aet, main = paste0("AET ", 1979:2022))
animate(cwd, main = paste0("CWD ", 1979:2022))

## aet_plot <- ggplot() +
## ##    geom_spatraster(data = shade, show.legend = FALSE) +
## ##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
## ##    ggnewscale::new_scale_fill() +
##     geom_spatraster(data = clamp(aet, lower = 100, upper = 200, values = NA), alpha = 1) +
##     scale_fill_viridis_c(option = "D") +
##     geom_sf(data = units, fill = NA, lwd = 1.5) +
##     geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
##     labs(title = "AET") +
##     annotation_north_arrow(aes(location = "tr")) +
##     annotation_scale(aes(location = "br")) +
##     transition_states(names)

## gganimate::animate(
##   aet_plot,
##   width = 12,
##   height = 8,
##   renderer=gifski_renderer("map.gif")
##   )

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
##    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(aet_mean_2000, lower = 100, upper = 200, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "D") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "1980-2000 mean annual sum of AET (mm), 100-200mm") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_mean_2000, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "1980-2000 mean annual sum of Deficit (mm), >= 100mm") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

aet_mean <- aet %>% subset(year(time(.)) >= 2002 & year(time(.)) <= 2022) %>% mean()
cwd_mean <- cwd %>% subset(year(time(.)) >= 2002 & year(time(.)) <= 2022) %>% mean()

pal_greys <- hcl.colors(1000, "Grays")

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
##    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(aet_mean, lower = 100, upper = 200, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "D") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "2002-2022 mean annual sum of AET (mm), 100-200mm") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
ggsave("burroughs_2002-2022_aet.png", width=16, height=12)


ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_mean, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "2002-2022 mean annual sum of Deficit (mm), >= 100mm") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
ggsave("burroughs_2002-2022_deficit.png", width=16, height=12)


zonal(aet_mean, vect(units), fun = "mean", na.rm = TRUE)
zonal(cwd_mean, vect(units), fun = "mean", na.rm = TRUE)

cwd_mean_thresh <- cwd_mean <= 175

ggplot() +
    geom_spatraster(data = shade, show.legend = FALSE) +
##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_mean, alpha = 0.85) +
    scale_fill_viridis_b(option = "F", direction = 1, breaks = c(0,50,100,150,200,250,300)) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "2002-2022 mean annual sum of Deficit, areas <= 110m D") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


ggplot() +
    geom_spatraster(data = shade, show.legend = FALSE) +
##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = aet_mean, alpha = 0.85) +
    scale_fill_viridis_b(option = "D", direction = 1, breaks = c(50,100,150,200)) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "2002-2022 mean annual sum of AET, areas <= 110m D") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))



ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
##    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(aet_1988, lower = 50, upper = 200, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "D") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "1988 AET") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
##    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_1988, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "1988 CWD") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


current <- 2006:2024
near <- 2025:2049
mid <- 2050:2074
end <- 2075:2099

ens_dir <- file.path("/media/smithers/shuysman/data/burroughs/sums/ensembles/")

cwd_ens45 <- rast(file.path(ens_dir, "ensemble_rcp45_Deficit_annual_sum_burroughs.nc")) %>%
    clamp(lower = 0, values = NA) / 10

cwd_ens45_near <- cwd_ens45 %>% subset(year(time(.)) %in% near) %>% mean()
cwd_ens45_mid <- cwd_ens45 %>% subset(year(time(.)) %in% mid) %>% mean()
cwd_ens45_end <- cwd_ens45 %>% subset(year(time(.)) %in% end) %>% mean()

cwd_ens85 <- rast(file.path(ens_dir, "ensemble_rcp85_Deficit_annual_sum_burroughs.nc")) %>%
    clamp(lower = 0, values = NA) / 10

cwd_ens85_near <- cwd_ens85 %>% subset(year(time(.)) %in% near) %>% mean()
cwd_ens85_mid <- cwd_ens85 %>% subset(year(time(.)) %in% mid) %>% mean()
cwd_ens85_end <- cwd_ens85 %>% subset(year(time(.)) %in% end) %>% mean()

aet_ens45 <- rast(file.path(ens_dir, "ensemble_rcp45_AET_annual_sum_burroughs.nc")) %>%
    clamp(lower = 0, values = NA) / 10

aet_ens45_near <- aet_ens45 %>% subset(year(time(.)) %in% near) %>% mean()
aet_ens45_mid <- aet_ens45 %>% subset(year(time(.)) %in% mid) %>% mean()
aet_ens45_end <- aet_ens45 %>% subset(year(time(.)) %in% end) %>% mean()

aet_ens85 <- rast(file.path(ens_dir, "ensemble_rcp85_AET_annual_sum_burroughs.nc")) %>%
    clamp(lower = 0, values = NA) / 10

aet_ens85_near <- aet_ens85 %>% subset(year(time(.)) %in% near) %>% mean()
aet_ens85_mid <- aet_ens85 %>% subset(year(time(.)) %in% mid) %>% mean()
aet_ens85_end <- aet_ens85 %>% subset(year(time(.)) %in% end) %>% mean()


ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_ens45_near, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD, Near-future (2025-2049)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_ens45_mid, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD, Mid-century (2050-2074)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_ens45_end, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD, End-century (2075-2099)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD, End-century (2075-2099)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


cwd_rcp85_change_from_baseline <- cwd_ens85_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp85_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "RCP8.5 Ensemble Mean CWD end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

aet_rcp45_change_from_baseline <- aet_ens45_end - aet_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "G") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean AET end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


aet_rcp85_change_from_baseline <- aet_ens85_end - aet_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = aet_rcp85_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "RCP8.5 Ensemble Mean AET end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


```
