```{r}
library(tidyverse)
library(sf)
library(elevatr)
library(tidyterra)
library(climateR)
library(soilDB)
library(slider)
library(terra)

units <- st_read("./data/units/Possible_WBP_Units_Nancy_Updated.shp") %>% st_cast("MULTIPOLYGON")

units_4326 <- units %>% st_transform(crs = crs("EPSG:4326"))

elev_rast_aws <- get_elev_raster(units, z = 14, src = "aws")

## USGS 1m LiDAR DEM
## Dataset Citation: United States Geological Survey (2021). United States Geological Survey 3D Elevation Program 1 meter Digital Elevation Model. Distributed by OpenTopography. https://doi.org/10.5069/G98K778D. Accessed: 2024-05-07 

elev_rast <- rast("./data/burroughs_creek_USGS1m.tif")

autoplot(elev_rast) +
  theme_minimal()

slope <- terrain(elev_rast, v="slope") 
aspect <- terrain(elev_rast, v="aspect")

shade <- terra::shade(slope, aspect, 30, 270)

pal_greys <- hcl.colors(1000, "Grays")

ggplot() +
    geom_spatraster(data = aspect) +
    geom_sf(data = units, fill = NA, lwd = 2)

ggplot() +
    geom_spatraster(data = slope) +
    geom_sf(data = units, fill = NA, lwd = 2)

ggplot() +
    geom_spatraster(data = shade) +
##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
    geom_sf(data = units, fill = NA, lwd = 2) +
    scale_fill_gradientn(colors = pal_greys, na.value = NA)


gridmet_data <- getGridMET(units_4326, varname = c("tmmn", "tmmx", "pr"), startDate = "1980-01-01", endDate = "2022-12-31")

names(gridmet_data$precipitation_amount) <- rep("pr", nlyr(gridmet_data$precipitation_amount))
names(gridmet_data$daily_maximum_temperature) <- rep("tmmx", nlyr(gridmet_data$daily_maximum_temperature))
names(gridmet_data$daily_minimum_temperature) <- rep("tmmn", nlyr(gridmet_data$daily_minimum_temperature))

gridmet_data$daily_average_temperature <- (gridmet_data$daily_maximum_temperature + gridmet_data$daily_minimum_temperature) / 2

gridmet_sds <- sds(gridmet_data)

##gridmet_spatraster <- c(gridmet_data$precipitation_amount, gridmet_data$daily_maximum_temperature, gridmet_data$daily_minimum_temperature)

melt_factor <- terra::app(gridmet_data$daily_average_temperature - 273.15, function (x) {
    case_when(x <= 0 ~ 0,
              x < 6 ~ 0.167 * x,
              x >= 6 ~ 1)
})

names(melt_factor) <- rep("f", nlyr(melt_factor))
time(melt_factor) <- time(gridmet_data$daily_average_temperature)
gridmet_sds <- c(gridmet_sds, melt_factor = melt_factor)

rain <- melt_factor * gridmet_data$precipitation_amount
snow <- (1 - melt_factor) * gridmet_data$precipitation_amount

gridmet_sds <- c(gridmet_sds, rain = rain)
gridmet_sds <- c(gridmet_sds, snow = snow)

get_pack <- function (ppt, F, sp.0=NULL) {
    snowpack <- vector()
    sp.0 <- ifelse(!is.null(sp.0), sp.0, 0)
    for (i in 1:length(ppt)) {
        if (i == 1) {
            snowpack[i] = (1 - F[i])**2 * ppt[i] + (1 - F[i]) * sp.0
        } else {
            snowpack[i] = (1 - F[i])**2 * ppt[i] + (1 - F[i]) * snowpack[i - 1]
        }
    }
    return(snowpack)
}

pack <- terra::lapp(sds(gridmet_sds$precipitation_amount, gridmet_sds$melt_factor), fun = get_pack)

gridmet_sds <- c(gridmet_sds, pack = pack)

get_melt <- function (snow, pack, F, sp.0=NULL) {
    sp.0 <- ifelse(!is.null(sp.0), sp.0, 0)
    melt <- vector()
    for (i in 1:length(snow)) {
      if ( i == 1 ) {
        melt[i] = F[i] * (snow[i] + sp.0)
      } else {
        melt[i] = F[i] * (snow[i] + pack[i-1])
      }
    }
    return(melt)
}

melt <- terra::lapp(sds(gridmet_sds$snow, gridmet_sds$pack, gridmet_sds$melt_factor), fun = get_melt)


## ssurgo_geom <- SDA_spatialQuery(st_as_sfc(st_bbox(units_4326)), what = "mupolygon", db = "SSURGO", geomIntersection = TRUE)

## mu.is <- format_SQL_in_statement(ssurgo_geom$mukey[1])
## sql <- sprintf("mukey IN %s", mu.is)

## x <- fetchSDA(sql)




```


# Analysis
1. Prepare layers
Everything projected, resampled, and cropped using 1m LiDAR DEM as Reference
- DEM
1m LiDAR opentopography.org
- resample_layers.R
	dayl
	t50
- slope (GDAL in QGIS)
- aspect (GDAL in QGIS)
- split_ncs.R/split_ncs.sbatch
  Split climate inputs (tmax, tmin, Precip) into tifs, 1 tif per day
  Results in millions of layers for each combo of day/year/gcm/scenario/variable
- Soil
SSURGO data from Curve Number Generator in QGIS
150 cm depth AWC

2. Run WB
start_wb_v_1_5.py

3. Collate
collate.R

4. Annual sums of AET/Deficit
annual_sum.sh using CDO


``` r

##time(output_rast) <- time(reference)

##test_ext <- c(606336, 607500, 4839876, 4840600)

units <- st_read("./data/units/Possible_WBP_Units_Nancy_Updated.shp") %>% st_cast("MULTIPOLYGON")

elev <- rast("./data/burroughs_creek_USGS1m_clipped_nad83.tif") 

shade <- rast("./data/burroughs_creek_USGS1m_clipped_hillshade_nad83.tif")

autoplot(shade)

pal_greys <- hcl.colors(1000, "Grays")

## ggplot() +
##     geom_spatraster(data = shade) +
## ##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
##     scale_fill_gradientn(colors = pal_greys, na.value = NA)

r <- output_rast %>%
    subset(1,9999) %>%
    ##crop(test_ext) %>%
    clamp(lower = 0, values = FALSE) %>%
    sum()

ggplot() +
    geom_spatraster(data = shade) +
##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = r, alpha = 0.5) +
    scale_fill_viridis_c(option = "A") +
    geom_sf(data = units, fill = NA, lwd = 1.5)


library(rayshader)
library(abind)

#And convert it to a matrix:
elmat = raster_to_matrix(elev)

coltb <- data.frame(value=1:1000, col=rainbow(1000, end=.9))
coltab(r) <- coltb
RGB(r) <- c(1,1,1)
def_colors = colorize(r)

defmat = abind(elmat,raster_to_matrix(r), along = 3)
#alpha = array(1, dim = dim(defmat))
#defmat = abind(defmat, alpha, along = 4)

#defmat = raster_to_matrix(r)

#We use another one of rayshader's built-in textures:
elmat %>%
    sphere_shade() %>%
    ##add_water(detect_water(elmat), color = "desert") %>%
    add_overlay(overlay = defmat) %>%
    plot_3d(elmat)


render_camera(fov = 0, theta = 60, zoom = 0.75, phi = 45)
render_scalebar(limits=c(0, 5, 10),label_unit = "km",position = "W", y=50,
                scale_length = c(0.33,1))
render_compass(position = "E")

```

``` r
library(tidyverse)
library(terra)
library(tidyterra)
library(sf)
library(ggnewscale)
library(ggspatial)

terraOptions(verbose = TRUE)

burroughs_data_dir <- file.path("~/out/")

units <- st_read("./data/units/Possible_WBP_Units_Nancy_Updated.shp") %>% st_cast("MULTIPOLYGON")

elev <- rast("./data/burroughs_creek_USGS1m_clipped_nad83.tif") 

shade <- rast("./data/burroughs_creek_USGS1m_clipped_hillshade_nad83.tif")

### Use annual_sums.sh script to generate annual sums
## aet_files <- list.files(burroughs_data_dir, "AET.*", full.names = TRUE)

## aet <- rast(aet_files,  drivers="NETCDF")

## aet_sum <- aet |>
##     terra::tapp(index = "years",
##                 fun = sum,
##                 filename = "~/out/AET_annual_sum_burroughs.nc")


## aet_sum <- rast("~/out/AET_annual_sum_burroughs.nc") |>
##     clamp(lower = 0, values = NA) / 10

## time(aet_sum) <- 1979:2022

## mean_aet_sum <- mean(aet_sum)

## cwd_files <- list.files(burroughs_data_dir, "Deficit.*", full.names = TRUE)

## cwd <- rast(cwd_files,  drivers="NETCDF")

## cwd_sum <- cwd |>
##     terra::tapp(index = "years",
##                 fun = sum,
##                 filename = "~/out/Deficit_annual_sum_burroughs.nc")



aet <- rast(file.path(burroughs_data_dir, "AET_annual_sum_burroughs.nc")) |>
    clamp(lower = 0, values = NA)
cwd <- rast(file.path(burroughs_data_dir, "Deficit_annual_sum_burroughs.nc")) |>
    clamp(lower = 0, values = NA)

aet_mean_2000 <- aet %>% subset(year(time(.)) >= 1980 & year(time(.)) <= 2000) %>% mean() / 10
cwd_mean_2000 <- cwd %>% subset(year(time(.)) >= 1980 & year(time(.)) <= 2000) %>% mean() / 10

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
##    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(aet_mean_2000, lower = 100, upper = 200, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "D") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "1980-2000 mean annual sum of AET (mm), 100-200mm") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_mean_2000, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "1980-2000 mean annual sum of Deficit (mm), >= 100mm") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = accumswe_max_2000, alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "1980-2000 mean annual max of accumswe (mm), >= 100mm") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

aet_mean <- aet %>% subset(year(time(.)) >= 2002 & year(time(.)) <= 2022) %>% mean() / 10
cwd_mean <- cwd %>% subset(year(time(.)) >= 2002 & year(time(.)) <= 2022) %>% mean() / 10

pal_greys <- hcl.colors(1000, "Grays")

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
##    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(aet_mean, lower = 100, upper = 200, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "D") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "2002-2022 mean annual sum of AET (mm), 100-200mm") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
ggsave("burroughs_2002-2022_aet.png", width=16, height=12)


ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_mean, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "2002-2022 mean annual sum of Deficit (mm), >= 100mm") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
ggsave("burroughs_2002-2022_deficit.png", width=16, height=12)


zonal(cwd_mean, vect(units), fun = "mean", na.rm = TRUE)

cwd_mean_thresh <- cwd_mean <= 175

ggplot() +
    geom_spatraster(data = shade, show.legend = FALSE) +
##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_mean, alpha = 0.85) +
    scale_fill_viridis_b(option = "F", direction = 1, breaks = c(0,50,100,150,200,250,300)) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "2002-2022 mean annual sum of Deficit, areas <= 110m D") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


ggplot() +
    geom_spatraster(data = shade, show.legend = FALSE) +
##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = aet_mean, alpha = 0.85) +
    scale_fill_viridis_b(option = "D", direction = 1, breaks = c(50,100,150,200)) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = DESCRIPTIO), fill = NA) +
    labs(title = "2002-2022 mean annual sum of AET, areas <= 110m D") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

```
