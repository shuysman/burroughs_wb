---
title: 'Burroughs Creek WBP Planting Unit Microsites'
author: "Stephen Huysman"
email: "shuysman@gmail.com"
date: "`r Sys.Date()`"
fontsize: 10pt 
bibliography: library.bib
csl: global-ecology-and-biogeography.csl
output:
  rmdformats::robobook:
    lightbox: true
---

```{css, echo=FALSE}
body .main-container {
    max-width: 2000px !important;
    width: 1080px !important;
}
body {
    max-width: 2000px !important;
}
```

``` {r setup, include = FALSE}
library(tidyverse)
library(sf)
library(terra)
library(tidyterra)
library(ggnewscale)
library(ggspatial)
library(ggpubr)
library(kableExtra)

terraOptions(verbose = TRUE,
             memfrac = 0.9)

elev <- rast("./data/burroughs_creek_USGS1m_clipped_nad83.tif") 
aspect <- rast("./data/planting_unit_aspect.tif")
slope <- rast("./data/planting_unit_slope.tif")
shade <- rast("./data/burroughs_creek_USGS1m_clipped_hillshade_nad83.tif")
soil <- rast("./data/soil_whc_025_aligned_clipped.tif") %>% round(2) %>% clamp(lower = 0, values = NA)

pal_greys <- hcl.colors(1000, "Grays")

units <- st_read("./data/units/Possible_WBP_Units_Nancy_Updated.shp") %>% st_cast("MULTIPOLYGON")


### Generate fs roads gpkg with only burroughs roads
## fs_roads <- st_read("./data/fs_roads/S_USA.RoadCore_FS.shp")

## elev2 <- project(elev, crs(fs_roads))
## bbox <- st_bbox(elev2) %>% st_as_sfc()
## fs_roads <- st_intersection(fs_roads, bbox)

## st_write(fs_roads, "./data/fs_roads_burroughs.gpkg")

fs_roads <- st_read("./data/fs_roads_burroughs.gpkg")

stats <- data.frame(elev_mean = zonal(elev, vect(units), fun = "mean")[[1]],
                         elev_max = zonal(elev, vect(units), fun = "max")[[1]],
                         elev_min = zonal(elev, vect(units), fun = "min")[[1]],
                         slope_mean = zonal(slope, vect(units), fun = "mean", na.rm = TRUE)[[1]],
                         slope_max = zonal(slope, vect(units), fun = "max", na.rm = TRUE)[[1]],
                         slope_min = zonal(slope, vect(units), fun = "min", na.rm = TRUE)[[1]],
                         aspect_mean = zonal(aspect, vect(units), fun = "mean", na.rm = TRUE)[[1]]
                    )

units <- bind_cols(units, stats)
```

# Introduction

`r crs(elev, proj = TRUE)`

`r st_bbox(elev)`

## Planting Units

```{r planting-units, fig.height = 8, fig.width = 10, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
knitr::kable(select(as_tibble(units),
                    Unit,
                    Description = DESCRIPTIO,
                    Acres = ACRES,
                    elev_mean,
                    elev_max,
                    elev_min,
                    slope_mean,
                    slope_max,
                    slope_min,
                    aspect_mean),
             digits = 2)

ggplot() +
    geom_spatraster(data = shade, show.legend = FALSE) +
##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    geom_sf(data = fs_roads, color = "orange", lwd = 1.5, alpha = 0.5) +
    geom_sf_text(data = fs_roads, aes(label = ID), alpha = 0.9) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), alpha = 0.4) +
    labs(title = "Burroughs WBP Planting Units Hillshade") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
```

### Elevation Bias
This is the difference between the elevation used for the gridMET cell that was used for climate data (2813.28m) and the elevatio of each cell in the 1m LiDAR DEM.  Temperate varies along elevational and failure to account for lapse rates can result in error in calculated water balance metrics (Tercek et al. 2021).  Actual daily max and min temperatures could be higher or lower depending on how much higher or lower the point is compared to the elevation used to model the gridMET cell.
``` {r elev-bias, echo = FALSE, message = FALSE}

metdata_elev <- rast("./data/metdata_elevationdata.nc") %>%
    project(elev, method = "near")

## bias <- elev - metdata_elev

## ggplot() +
##     geom_spatraster(data = bias) +
##     scale_fill_viridis_c(option = "A") +
##     labs(title = "Burroughs WBP Planting Units Elevation Bias") +
##     annotation_north_arrow(aes(location = "tr")) +
##     annotation_scale(aes(location = "br"))

elev_used <- 2813.28

bias_used <- elev - elev_used

ggplot() +
    geom_spatraster(data = bias_used) +
    scale_fill_viridis_c(option = "A") +
    labs(title = "Burroughs WBP Planting Units Elevation Bias") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), alpha = 0.4) +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


## Average bias per unit
zonal(elev, vect(units), fun = "mean") - elev_used

## Largest observed biases
zonal(elev, vect(units), fun = "max") - elev_used
zonal(elev, vect(units), fun = "min") - elev_used
```
##  Soils
``` {r soils, fig.height = 8, fig.width = 10, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
ggplot() +
    geom_spatraster(data = soil) +
    labs(title = "Burroughs WBP Planting Unit Soil WHC (mm) to 25cm soil depth") +
    scale_fill_viridis_b() +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
```

Soils range from `r global(soil, min, na.rm = TRUE)[[1]]` to `r global(soil, max, na.rm = TRUE)[[1]]` mm whc at 25 cm soil depth. Soil water capacity at 25 cm was selected because the application of this report is for planting seedlings and mature whitebark pine trees typically have shallow root systems not typically penetrating more than 30cm of soil (https://www.fs.usda.gov/database/feis/plants/tree/pinalb/all.html).

``` {r soils-zonals, echo = FALSE}
zonal(soil, vect(units), fun = "mean", na.rm = TRUE) %>%
    cbind(Unit = units$Unit, .) %>%
    knitr::kable(digits = 2, col.names = c("Unit", "Mean Soil WHC (mm)")) %>%
    kable_styling(full_width = F)
```


## T50

``` {r include = FALSE}
t50 <- global(rast("./data/jennings_t50_coefficients.tif"), "mean")[[1]]
```

Jennings *T*~50~ coeffcient used for all cells = `r t50`

# Methods
## Analysis
1. Prepare layers
Everything projected, resampled, and cropped using 1m LiDAR DEM as Reference
- DEM
1m LiDAR opentopography.org
- resample_layers.R
	dayl
	t50
- slope (GDAL in QGIS)
- aspect (GDAL in QGIS)
- split_ncs.R/split_ncs.sbatch
  Split climate inputs (tmax, tmin, Precip) into tifs, 1 tif per day
  Results in millions of layers for each combo of day/year/gcm/scenario/variable
- Soil
SSURGO data from Curve Number Generator in QGIS
25 cm depth AWC

2. Run WB
start_wb_v_1_5.py

3. Collate
collate.R

4. Annual sums of AET/Deficit
annual_sum.sh using CDO


## Grids
### 4km (gridMET/MACA scale)
- t
- p
- accumswe
### 1m (DEM scale)
- Elevation (1m lidar)
- Slope (1m lidar derived)
- Aspect (1m lidar derived)

### Other/TBD
- soil (1:24000 ssurgo)
- dayl (1 km daymet, I think)
- t50 (4km? see jennings file)

# Results

## Historical

``` {r historical, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 16, out.width = '100%'}
gridmet_data_dir <- file.path("~/out/sums/")

aet <- rast(file.path(gridmet_data_dir, "historical_gridmet_AET_annual_sum_burroughs.nc")) |>
    clamp(lower = 0, values = NA) / 10
cwd <- rast(file.path(gridmet_data_dir, "historical_gridmet_Deficit_annual_sum_burroughs.nc")) |>
    clamp(lower = 0, values = NA) / 10


### 1988 Drought Year
aet_1988 <- aet %>% subset(year(time(.)) == 1988)
cwd_1988 <- cwd %>% subset(year(time(.)) == 1988)

### Previous 20 years before current
aet_2002 <- aet %>% subset(year(time(.)) >= 1982 & year(time(.)) <= 2002) %>% mean()
cwd_2002 <- cwd %>% subset(year(time(.)) >= 1982 & year(time(.)) <= 2002) %>% mean()

### Last 20 years
aet_2022 <- aet %>% subset(year(time(.)) >= 2002 & year(time(.)) <= 2022) %>% mean()
cwd_2022 <- cwd %>% subset(year(time(.)) >= 2002 & year(time(.)) <= 2022) %>% mean()

years = c(1988, 2002, 2022)
vars = c("aet", "cwd")
types = c("mean", "min", "max")

unit_stats <- tibble()
for (year in years) {
    for (var in vars) {
        for (type in types) {
            unit_stats <- bind_rows(unit_stats,
                               bind_cols(year = year,
                                         var = var,
                                         type = type,
                                         value = zonal(get(glue::glue("{var}_{year}")), vect(units), fun = type, na.rm = TRUE)[[1]]))
        }
    }
}

unit_stats <- bind_cols(unit = rep(units$Unit, nrow(unit_stats) / 2), unit_stats)

unit_stats %>% pivot_wider(id_cols = c(unit, year, var),
                            names_from = type,
                           values_from = value) %>%
    ggplot(aes(x = year, y = mean, color = unit)) +
    geom_line() +
    geom_ribbon(aes(ymin = min, ymax = max, fill = unit), linetype = "dashed", alpha = 0.1) +
    ##geom_linerange(aes(x = year, y = mean, ymin = min, ymax = max), color = unit) +
    facet_wrap(~var)


knitr::kable(select(unit_stats,
                    Unit, DESCRIPTIO, aet_1988:cwd_2022),
             digits = 2)


unit_stats %>% pivot_longer(cols = starts_with(c("aet"))) %>%
    ggplot() +
    geom_line(aes(x = name, y = value, group = Unit, color = Unit)) +
    labs(title = "Change in AET normals vs 1988 drought year")

unit_stats %>% pivot_longer(cols = starts_with(c("cwd"))) %>%
    ggplot() +
    geom_line(aes(x = name, y = value, group = Unit, color = Unit)) +
    labs(title = "Change in CWD normals vs 1988 drought year")

aet_scale <-
    scale_fill_viridis_c(option = "D", limits = c(50, 300))

cwd_scale <-
    scale_fill_viridis_c(option = "B", limits = c(0, 350))

aet_2002_plot <- ggplot() +
    geom_spatraster(data = aet_2002, alpha = 1) +
    aet_scale + 
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1982-2002 mean annual sum of AET (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_2002_plot <- ggplot() +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data =cwd_2002, alpha = 1) +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1982-2002 mean annual sum of Deficit (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


aet_2022_plot <- ggplot() +
    geom_spatraster(data = aet_2022, alpha = 1) +
    aet_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "2002-2022 mean annual sum of AET (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
##ggsave("burroughs_2002-2022_aet.png", width=16, height=12)


cwd_2022_plot <- ggplot() +
    geom_spatraster(data = cwd_2022, alpha = 1) +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "2002-2022 mean annual sum of Deficit (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
##ggsave("burroughs_2002-2022_deficit.png", width=16, height=12)



aet_1988_plot <- ggplot() +
    geom_spatraster(data = aet_1988, alpha = 1) +
    theme(legend.position="bottom") +
    aet_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1988 AET (Drought Year)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


cwd_1988_plot <- ggplot() +
    geom_spatraster(data = cwd_1988, alpha = 1) +
    theme(legend.position="bottom") +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1988 CWD (Drought Year)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


ggarrange(aet_2002_plot, aet_2022_plot, common.legend = TRUE)
ggarrange(cwd_2002_plot, cwd_2022_plot, common.legend = TRUE)

ggarrange(aet_1988_plot, cwd_1988_plot)


```


``` {r eval = F, include = F}
current <- 2006:2024
near <- 2025:2049
mid <- 2050:2074
end <- 2075:2099

ens_dir <- file.path("/media/smithers/shuysman/data/burroughs/sums/ensembles/")

cwd_ens45 <- rast(file.path(ens_dir, "ensemble_rcp45_Deficit_annual_sum_burroughs.nc")) %>%
    clamp(lower = 0, values = NA) / 10

cwd_ens45_near <- cwd_ens45 %>% subset(year(time(.)) %in% near) %>% mean()
cwd_ens45_mid <- cwd_ens45 %>% subset(year(time(.)) %in% mid) %>% mean()
cwd_ens45_end <- cwd_ens45 %>% subset(year(time(.)) %in% end) %>% mean()

cwd_ens85 <- rast(file.path(ens_dir, "ensemble_rcp85_Deficit_annual_sum_burroughs.nc")) %>%
    clamp(lower = 0, values = NA) / 10

cwd_ens85_near <- cwd_ens85 %>% subset(year(time(.)) %in% near) %>% mean()
cwd_ens85_mid <- cwd_ens85 %>% subset(year(time(.)) %in% mid) %>% mean()
cwd_ens85_end <- cwd_ens85 %>% subset(year(time(.)) %in% end) %>% mean()

aet_ens45 <- rast(file.path(ens_dir, "ensemble_rcp45_AET_annual_sum_burroughs.nc")) %>%
    clamp(lower = 0, values = NA) / 10

aet_ens45_near <- aet_ens45 %>% subset(year(time(.)) %in% near) %>% mean()
aet_ens45_mid <- aet_ens45 %>% subset(year(time(.)) %in% mid) %>% mean()
aet_ens45_end <- aet_ens45 %>% subset(year(time(.)) %in% end) %>% mean()

aet_ens85 <- rast(file.path(ens_dir, "ensemble_rcp85_AET_annual_sum_burroughs.nc")) %>%
    clamp(lower = 0, values = NA) / 10

aet_ens85_near <- aet_ens85 %>% subset(year(time(.)) %in% near) %>% mean()
aet_ens85_mid <- aet_ens85 %>% subset(year(time(.)) %in% mid) %>% mean()
aet_ens85_end <- aet_ens85 %>% subset(year(time(.)) %in% end) %>% mean()


ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_ens45_near, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD, Near-future (2025-2049)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_ens45_mid, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD, Mid-century (2050-2074)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = clamp(cwd_ens45_end, lower = 100, values = NA), alpha = 1) +
    scale_fill_viridis_c(option = "B", direction = 1) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD, End-century (2075-2099)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD, End-century (2075-2099)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean CWD end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


cwd_rcp85_change_from_baseline <- cwd_ens85_end - cwd_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp85_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP8.5 Ensemble Mean CWD end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

aet_rcp45_change_from_baseline <- aet_ens45_end - aet_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "G") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5 Ensemble Mean AET end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


aet_rcp85_change_from_baseline <- aet_ens85_end - aet_mean

ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = aet_rcp85_change_from_baseline, alpha = 1) +
    scale_fill_viridis_c(option = "E") +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP8.5 Ensemble Mean AET end-of-century change from baseline (2002-2022)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


```


# Discussion
## Best Planting Sites
``` {r best-plantings}
n_sites <- 1000000

(n_sites / ncell(elev)) * 100

highest_aet <- selectHighest(aet_2022, n = n_sites)
lowest_cwd <- selectHighest(cwd_2022, n = n_sites, low = TRUE)

best_sites <- highest_aet & lowest_cwd

(n_best_sites <- zonal(best_sites, best_sites, length)[[2]])

(n_best_sites / ncell(elev)) * 100

(mean_aet <- global(mask(aet_2022, highest_aet), fun = "mean", na.rm = TRUE))
(mean_cwd <- global(mask(cwd_2022, lowest_cwd), fun = "mean", na.rm = TRUE))


ggplot() +
    geom_spatraster(data = shade, show.legend = FALSE) +
##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = best_sites) +
    scale_fill_discrete(na.value = "transparent") +
    geom_sf(data = fs_roads, color = "orange", lwd = 1.5, alpha = 0.5) +
    geom_sf_text(data = fs_roads, aes(label = ID), alpha = 0.9) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), alpha = 0.4) +
    labs(title = glue::glue("Best Planting Sites (Highest AET + Lowest Deficit 2002-2022) n = {n_best_sites}, {round(n_best_sites * 100 / ncell(elev), 2)}%")) +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

bind_cols(units, 
          sum_area_best_sites = zonal(best_sites, vect(units), fun = "sum", na.rm = TRUE)[[1]]) %>%
    as_tibble() %>%
    select(Unit, sum_area_best_sites) %>%
    knitr::kable(digits = 2)
```
Optimal planting locations will have high AET and low CWD, to maximize potential growth and minimize drought stress.  This algorithm selects for the n = `r n_sites` pixels with the highest AET and n with lowest CWD.  The logical union of these layers is taken to find the best sites, that simultaneously have the highest AET and lowest CWD possible, representing `r round(n_best_sites / ncell(elev), 2)` of the landscape.  

<!-- Local Variables: -->
<!-- jinx-local-words: "ncell" -->
<!-- End: -->
