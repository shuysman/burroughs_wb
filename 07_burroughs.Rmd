---
title: 'Burroughs Creek WBP Planting Microsites'
author: 
  - Stephen Huysman, shuysman@gmail.com
email: "shuysman@gmail.com"
date: "`r Sys.Date()`"
bibliography: library.bib
csl: global-ecology-and-biogeography.csl
link-citations: true
output:
  bookdown::html_document2:
    number_sections: true
---

```{css, echo=FALSE}
body .main-container {
    max-width: 2000px !important;
    width: 1080px !important;
}
body {
    max-width: 2000px !important;
}
```

``` {r setup, include = FALSE}
library(tidyverse)
library(sf)
library(terra)
library(tidyterra)
library(ggnewscale)
library(ggspatial)
library(ggpubr)
library(kableExtra)

terraOptions(verbose = FALSE,
             memfrac = 0.9)

elev <- rast("./data/burroughs_creek_USGS1m_clipped_nad83.tif") 
aspect <- rast("./data/planting_unit_aspect.tif")
slope <- rast("./data/planting_unit_slope.tif")
shade <- rast("./data/burroughs_creek_USGS1m_clipped_hillshade_nad83.tif")
soil <- rast("./data/soil_whc_025_aligned_clipped.tif") %>% round(2) %>% clamp(lower = 0, values = NA)

pal_greys <- hcl.colors(1000, "Grays")

units <- st_read("./data/units/Possible_WBP_Units_Nancy_Updated.shp") %>% st_cast("MULTIPOLYGON")

##  Generate fs roads gpkg with only burroughs roads
## fs_roads <- st_read("./data/fs_roads/S_USA.RoadCore_FS.shp")

## elev2 <- project(elev, crs(fs_roads))
## bbox <- st_bbox(elev2) %>% st_as_sfc()
## fs_roads <- st_intersection(fs_roads, bbox)

## st_write(fs_roads, "./data/fs_roads_burroughs.gpkg")

fs_roads <- st_read("./data/fs_roads_burroughs.gpkg")

stats <- data.frame(elev_mean = zonal(elev, vect(units), fun = "mean")[[1]],
                         elev_max = zonal(elev, vect(units), fun = "max")[[1]],
                         elev_min = zonal(elev, vect(units), fun = "min")[[1]],
                         slope_mean = zonal(slope, vect(units), fun = "mean", na.rm = TRUE)[[1]],
                         slope_max = zonal(slope, vect(units), fun = "max", na.rm = TRUE)[[1]],
                         slope_min = zonal(slope, vect(units), fun = "min", na.rm = TRUE)[[1]],
                         aspect_mean = zonal(aspect, vect(units), fun = "mean", na.rm = TRUE)[[1]]
                    )

units <- bind_cols(units, stats)
```

``` {r plot-settings, include = FALSE}
## Change from baseline plots
aet_change_scale <-
    scale_fill_viridis_c(option = "G", limits = c(0, 200))

cwd_change_scale <-
    scale_fill_viridis_c(option = "F", limits = c(0, 200))
```

# Introduction
This report presents historical (1979-2022) and projected (2006-2099)
water balance for the Burroughs Creek site (Figure \@ref(fig:planting-units)) in the Shoshone National
Forest.  This location was selected to plant whitebark pine (*Pinus
albicaulis*) seedlings in summer 2024.  The site previously burned in
August 30, 2013 in the Burroughs wildfire (MTBS ID
`wy4368810966320130830`).  The vegetation composition of the site
prior to the burn is unknown, but is assumed to have sustained
populations of whitebark pine.  Current satellite imagery shows that
the Burroughs wildfire cleared most trees from the site, with some
remnant trees persisting in sheltered locations.

This report applies the climatic water balance to the Burroughs Creek
site at a fine spatial scale to make recommendations of ideal planting
locations. Potential Evapotranspiration (PET) represents the potential
for plant growth given available energy if not limited by water
availability.  Actual Evapotranspiration (AET) is a measure of total
evaporative loss to the atmosphere, and is well-correlated with
measures of plant growth such as primary productivity.  The difference
between PET and AET is the Climatic Water Deficit (CWD), which
measures evaporative demand unmet by available water.  AET represents
the length and magnitude of growing conditions favorable to plants
while CWD provides a measure of drought stress.  The bivariate
relationship between AET and CWD is a robust tool to characterize the
biophysical environment of plants and has been shown to be
well-correlated with vegetation distributions across ten orders of
spatial magnitude
[@stephensonClimaticControlVegetation1990;@stephensonActualEvapotranspirationDeficit1998].

Fine-scale variation in topography and soil features has been shown to
strongly affect modeled water balance
[@dyerGISBasedWaterBalance2019]. These fine-scale variations in water
balance are intuitively understood by planters, who often select
planting locations based on microsite features such as presence of
logs or boulders that provide shade, decreasing evaporative demands.
Our objective was to use historical and projected climate data to
model the climatic water balance of the Burroughs Creek site using the
highest resolution topographic and soil survey data available to
understand fine-scale spatial variation in the climatic water balance
across the site in order to facilitate identification of suitable
planting microsites and guide planting of whitebark pine seedlings.
As whitebark pine is a long-lived tree species that reaches
reproductive age around 50 years in ideal conditions, successful
whitebark plantings require a consideration of both present and future
climatic conditions.

In general, desirable planting locations will have higher AET, to
promote rapid plant establishment and growth, and lower CWD, to
minimize drought stress and fire risk
[@thomaWaterBalanceIndicator2020].  Depending on management objects,
optimal site characteristics can vary and these results can be
interpreted in different ways.  For example, if management goals are
to:

1. Maximize successful establishment of seedlings - planters should
       choose planting locations that maximize AET to achieve higher
       seedling growth rates and minimize CWD to reduce drought
       stress.  Previous work has identified fastest growth rates in
       whitebark seedlings above an annual AET around 350 mm
       [@laufenbergBiophysicalGradientsPerformance2020].  Although
       direct comparisons with this work cannot be made without bias
       correction between the different climate data sets used, in
       general higher AET can be assumed to correlate with faster
       seedling growth and establishment.
2. Grow trees to cone-bearing age as quickly as possible - choose
       planting locations that maximize AET over the duration needed
       for trees to reach reproductive age, approximately 25-50 years.
3. Maximize longevity of adult trees - select planting locations that
       minimize interannual variability in stressors.  It is thought
       that trees can survive unfavorable conditions if they are
       adapted to them, and extreme swings in climatic conditions
       cause mortality in trees that are not adapted to those extremes
       (M. Tercek, personal communication, June 4, 2024).

## Planting Units

```{r planting-units, fig.cap = "Burroughs Creek Planting Units, with hillshade and USFS roads.", fig.height = 8, fig.width = 10, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
ggplot() +
    geom_spatraster(data = shade, show.legend = FALSE) +
##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    geom_sf(data = fs_roads, color = "orange", lwd = 1.5, alpha = 0.5) +
    geom_sf_text(data = fs_roads, aes(label = ID), alpha = 0.9) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), alpha = 0.4) +
    labs(title = "Burroughs WBP Planting Units Hillshade") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
```

``` {r planting-unit-statistics,  warning = FALSE, message = FALSE, echo = FALSE}
knitr::kable(
    select(as_tibble(units),
        Unit,
        Description = DESCRIPTIO,
        Acres = ACRES,
        elev_mean,
        elev_max,
        elev_min,
        slope_mean,
        slope_max,
        slope_min,
        aspect_mean
    ),
    digits = 2,
    caption = "Topographic Statistics of Burroughs Creek planting units")
```

##  Soils
``` {r soils, fig.height = 8, fig.width = 10, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE, fig.cap = "Burroughs Creek soil water holding capacity (WHC, mm).  WHC is taken from the SSURGO available water storage at 25 cm soil depth layer"}
ggplot() +
    geom_spatraster(data = soil) +
    labs(title = "Burroughs WBP Planting Unit Soil WHC (mm) to 25cm soil depth") +
    scale_fill_viridis_b() +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
```

Soils range from `r global(soil, min, na.rm = TRUE)[[1]]` to `r global(soil, max, na.rm = TRUE)[[1]]` mm whc at 25 cm soil depth
(Figure \@ref(fig:soils)). Soil water capacity at 25 cm was selected
because the application of this report is for planting seedlings and
mature whitebark pine trees typically have shallow root systems not
typically penetrating more than 30cm of soil
(https://www.fs.usda.gov/database/feis/plants/tree/pinalb/all.html).
Soils in the WB2 unit hold approximately 8 mm more water on average
(Table \@ref(tab:soils-zonals)).

``` {r soils-zonals, echo = FALSE}
zonal(soil, vect(units), fun = "mean", na.rm = TRUE) %>%
    cbind(Unit = units$Unit, .) %>%
    knitr::kable(digits = 2, col.names = c("Unit", "Mean Soil WHC (mm)"), caption = "Average soil WHC (mm)") %>%
    kable_styling(full_width = F)
```

The SSURGO soil automated report for the site can be read here [20240514_11420911928_90_Soil_Report.pdf](./20240514_11420911928_90_Soil_Report.pdf "20240514_11420911928_90_Soil_Report.pdf").

# Methods
A Thornthwaite-style water balance model
[@thornthwaiteApproachRationalClassification1948] was run at a
daily-time step for the area within the bounding box of the planting
units. Topographic and elevation data was provided by the 1-meter
LiDAR digital elevation model (DEM) provided by the USGS 3DEP
[@u.s.geologicalsurveyWYFEMAEast2020].  Slope and aspect were
calculated from the 3DEP DEM using tools provided in QGIS
[@QGIS_software].  

Soil water holding capacity (WHC) was estimated using the 'available
water storage from 0-25cm' (`aws025wta`) data provided by the SSURGO
database
[@naturalresourcesconservationserviceSoilSurveyGeographic2015].  A 1 m
raster was generated from the WHC data in QGIS using the 1 m DEM
raster as a reference for sampling grid cells.  

Historical climate data (maximum temperature, minimum temperature,
precipitation) from 1979-2022 was provided by the gridMET dataset at a
daily timestep and 4 km resolution
[@abatzoglouDevelopmentGriddedSurface2013].  Projected climate data
for the same variables was provided by the MACA data set at the same
timestep and spatial resolution
[@abatzoglouComparisonStatisticalDownscaling2012].  The MACA dataset
was downscaled using gridMET, so time series between 1979 and 2099 are
commensurate with no breaks between past and future. The historical
and projected climate grids were reprojected and resampled to the same
CRS, extent, and resolution as the 1 m DEM raster.

Temperature and Precipitation projections for the following GCMs from
the MACA data set were included in this analysis (n = 19):

`r models <- c("bcc-csm1-1-m",
  "bcc-csm1-1",
  "BNU-ESM",
  "CanESM2",
  "CNRM-CM5",
  "CSIRO-Mk3-6-0",
  "GFDL-ESM2G",
  "GFDL-ESM2M",
  "HadGEM2-CC365",
  "HadGEM2-ES365",
  "inmcm4",
  "IPSL-CM5A-LR",
  "IPSL-CM5A-MR",
  "IPSL-CM5B-LR",
  "MIROC5",
  "MIROC-ESM-CHEM",
  "MIROC-ESM",
  "MRI-CGCM3",
"NorESM1-M"); knitr::kable(models, col.names = c("GCM"))`


The Burroughs Creek site is much smaller in scale than the 4 km grid
cells, and falls at the center of the intersection of four grid cells.
To remove spatial discontinuities in the modeled water balance for the
site, the grid cell with an elevation closest to the mean elevation
for the site was selected and climate data from this grid cell was applied across the site.  

The daily water balance at a 1m resolution was modeled using a
modified version of the script used to generate the NPS 1 km Gridded
Water Balance product for the coterminous United States
[@tercekHistoricalChangesPlant2021].  Annual sums of AET (mm) and
Deficit (mm) were calculated for the historical dataset as well as for
each GCM/Scenario combination.  Ensemble averages for annual sums of
AET and Deficit were created.

For comparisons with projected conditions, annual AET and CWD sums
between 2002-2022 were averaged to use as current baseline conditions.
Projections were summarized in near-term (2025-2049), mid-century
(2050-2075), and end-century (2076-2099) periods.

<!-- `r crs(elev, proj = TRUE)` -->

<!-- `r st_bbox(elev)` -->

# Results

<!-- ## T50 -->

<!-- ``` {r include = FALSE} -->
<!-- t50 <- global(rast("./data/jennings_t50_coefficients.tif"), "mean")[[1]] -->
<!-- ``` -->

<!-- Jennings *T*~50~ coeffcient used for all cells = r t50 -->

<!-- # Methods -->
<!-- ## Analysis -->
<!-- 1. Prepare layers -->
<!-- Everything projected, resampled, and cropped using 1m LiDAR DEM as Reference -->
<!-- - DEM -->
<!-- 1m LiDAR opentopography.org -->
<!-- - resample_layers.R -->
<!-- 	dayl -->
<!-- 	t50 -->
<!-- - slope (GDAL in QGIS) -->
<!-- - aspect (GDAL in QGIS) -->
<!-- - split_ncs.R/split_ncs.sbatch -->
<!--   Split climate inputs (tmax, tmin, Precip) into tifs, 1 tif per day -->
<!--   Results in millions of layers for each combo of day/year/gcm/scenario/variable -->
<!-- - Soil -->
<!-- SSURGO data from Curve Number Generator in QGIS -->
<!-- 25 cm depth AWC -->

<!-- 2. Run WB -->
<!-- start_wb_v_1_5.py -->

<!-- 3. Collate -->
<!-- collate.R -->

<!-- 4. Annual sums of AET/Deficit -->
<!-- annual_sum.sh using CDO -->

## Historical Water Balance

``` {r historical, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 10, out.width = '100%'}
gridmet_data_dir <- file.path("~/out/sums/")

aet <- rast(file.path(gridmet_data_dir, "historical_gridmet_AET_annual_sum_burroughs.nc")) |>
    clamp(lower = 0, values = NA) / 10
cwd <- rast(file.path(gridmet_data_dir, "historical_gridmet_Deficit_annual_sum_burroughs.nc")) |>
    clamp(lower = 0, values = NA) / 10


### 1988 Drought Year
aet_1988 <- aet %>% subset(year(time(.)) == 1988)
cwd_1988 <- cwd %>% subset(year(time(.)) == 1988)

### Previous 20 years before current
aet_2002 <- aet %>% subset(year(time(.)) >= 1982 & year(time(.)) <= 2002) %>% mean()
cwd_2002 <- cwd %>% subset(year(time(.)) >= 1982 & year(time(.)) <= 2002) %>% mean()

### Last 20 years
aet_2022 <- aet %>% subset(year(time(.)) >= 2002 & year(time(.)) <= 2022) %>% mean()
cwd_2022 <- cwd %>% subset(year(time(.)) >= 2002 & year(time(.)) <= 2022) %>% mean()

years = c(1988, 2002, 2022)
vars = c("aet", "cwd")
types = c("mean", "min", "max")

unit_stats <- tibble()
for (year in years) {
    for (var in vars) {
        for (type in types) {
            unit_stats <- bind_rows(unit_stats,
                               bind_cols(year = year,
                                         var = var,
                                         type = type,
                                         value = zonal(get(glue::glue("{var}_{year}")), vect(units), fun = type, na.rm = TRUE)[[1]]))
        }
    }
}

unit_stats <- bind_cols(unit = rep(units$Unit, nrow(unit_stats) / 2), unit_stats)

## unit_stats %>% pivot_wider(id_cols = c(unit, year, var),
##                             names_from = type,
##                            values_from = value) %>%
##     ggplot(aes(x = year, y = mean, color = unit)) +
##     geom_line() +
##     geom_ribbon(aes(ymin = min, ymax = max, fill = unit), linetype = "dashed", alpha = 0.1) +
##     ##geom_linerange(aes(x = year, y = mean, ymin = min, ymax = max), color = unit) +
##     facet_wrap(~var)

## unit_stats %>% pivot_longer(cols = starts_with(c("aet"))) %>%
##     ggplot() +
##     geom_line(aes(x = name, y = value, group = Unit, color = Unit)) +
##     labs(title = "Change in AET normals vs 1988 drought year")

## unit_stats %>% pivot_longer(cols = starts_with(c("cwd"))) %>%
##     ggplot() +
##     geom_line(aes(x = name, y = value, group = Unit, color = Unit)) +
##     labs(title = "Change in CWD normals vs 1988 drought year")

aet_scale <-
    scale_fill_viridis_c(option = "D", limits = c(50, 350))

cwd_scale <-
  scale_fill_viridis_c(option = "B", limits = c(0, 400))

aet_sd_scale <-
    scale_fill_viridis_c(option = "A", limits = c(0, 15))

cwd_sd_scale <-
    scale_fill_viridis_c(option = "C", limits = c(0, 30))

aet_2002_plot <- ggplot() +
    geom_spatraster(data = aet_2002, alpha = 1) +
    aet_scale + 
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1982-2002 mean annual sum of AET (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_2002_plot <- ggplot() +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data =cwd_2002, alpha = 1) +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1982-2002 mean annual sum of Deficit (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


aet_2022_plot <- ggplot() +
    geom_spatraster(data = aet_2022, alpha = 1) +
    aet_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "2002-2022 mean annual sum of AET (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
##ggsave("burroughs_2002-2022_aet.png", width=16, height=12)


cwd_2022_plot <- ggplot() +
    geom_spatraster(data = cwd_2022, alpha = 1) +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "2002-2022 mean annual sum of Deficit (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
##ggsave("burroughs_2002-2022_deficit.png", width=16, height=12)



aet_1988_plot <- ggplot() +
    geom_spatraster(data = aet_1988, alpha = 1) +
    theme(legend.position="bottom") +
    aet_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1988 AET (Drought Year)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


cwd_1988_plot <- ggplot() +
    geom_spatraster(data = cwd_1988, alpha = 1) +
    theme(legend.position="bottom") +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1988 CWD (Drought Year)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
```

``` {r historical-aet-plot, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 16, out.width = '100%', fig.cap = "Historical AET (mm)"}
ggarrange(aet_2002_plot, aet_2022_plot, common.legend = TRUE)
```

``` {r historical-cwd-plot, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 16, out.width = '100%', fig.cap = "Historical CWD (mm)"} 
ggarrange(cwd_2002_plot, cwd_2022_plot, common.legend = TRUE)
```

``` {r drought-year-plot, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 16, out.width = '100%', fig.cap = "Drought Year Conditions (1988)"}
ggarrange(aet_1988_plot, cwd_1988_plot)
```

## Projected Water Balance

``` {r projections-setup, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 10, out.width = '100%'}
current <- 2006:2024
near <- 2025:2049
mid <- 2050:2074
end <- 2075:2099

ens_dir <- file.path("/media/smithers/shuysman/data/burroughs/sums/ensembles/")

cwd_ens45 <- rast(file.path(ens_dir, "ensemble_rcp45_Deficit_annual_sum_burroughs.nc")) %>%
  clamp(lower = 0, values = NA) / 10

cwd_ens45_near <- cwd_ens45 %>% subset(year(time(.)) %in% near) %>% mean()
cwd_ens45_mid <- cwd_ens45 %>% subset(year(time(.)) %in% mid) %>% mean()
cwd_ens45_end <- cwd_ens45 %>% subset(year(time(.)) %in% end) %>% mean()

cwd_ens85 <- rast(file.path(ens_dir, "ensemble_rcp85_Deficit_annual_sum_burroughs.nc")) %>%
  clamp(lower = 0, values = NA) / 10

cwd_ens85_near <- cwd_ens85 %>% subset(year(time(.)) %in% near) %>% mean()
cwd_ens85_mid <- cwd_ens85 %>% subset(year(time(.)) %in% mid) %>% mean()
cwd_ens85_end <- cwd_ens85 %>% subset(year(time(.)) %in% end) %>% mean()

aet_ens45 <- rast(file.path(ens_dir, "ensemble_rcp45_AET_annual_sum_burroughs.nc")) %>%
  clamp(lower = 0, values = NA) / 10

aet_ens45_near <- aet_ens45 %>% subset(year(time(.)) %in% near) %>% mean()
aet_ens45_mid <- aet_ens45 %>% subset(year(time(.)) %in% mid) %>% mean()
aet_ens45_end <- aet_ens45 %>% subset(year(time(.)) %in% end) %>% mean()

aet_ens85 <- rast(file.path(ens_dir, "ensemble_rcp85_AET_annual_sum_burroughs.nc")) %>%
  clamp(lower = 0, values = NA) / 10

aet_ens85_near <- aet_ens85 %>% subset(year(time(.)) %in% near) %>% mean()
aet_ens85_mid <- aet_ens85 %>% subset(year(time(.)) %in% mid) %>% mean()
aet_ens85_end <- aet_ens85 %>% subset(year(time(.)) %in% end) %>% mean()


aet_ens45_end_sd <- aet_ens45 %>%
  subset(year(time(.)) %in% end) %>%
  stdev()
aet_ens85_end_sd <- aet_ens85 %>%
  subset(year(time(.)) %in% end) %>%
  stdev()

cwd_ens45_end_sd <- cwd_ens45 %>%
  subset(year(time(.)) %in% end) %>%
  stdev()
cwd_ens85_end_sd <- cwd_ens85 %>%
  subset(year(time(.)) %in% end) %>%
  stdev()
```

```{r cwd-projections, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 16, fig.width = 12, out.width = '100%', fig.cap = "Ensemble mean annual CWD (mm), RCP4.5 and RCP8.5 scenarios."}
cwd_ens45_near_plot <- ggplot() +
  geom_spatraster(data = clamp(cwd_ens45_near, lower = 100, values = NA), alpha = 1) +
  cwd_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP4.5 Near-future (2025-2049)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

cwd_ens45_mid_plot <- ggplot() +
  geom_spatraster(data = clamp(cwd_ens45_mid, lower = 100, values = NA), alpha = 1) +
  cwd_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP4.5 Mid-century (2050-2074)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

cwd_ens45_end_plot <- ggplot() +
  geom_spatraster(data = clamp(cwd_ens45_end, lower = 100, values = NA), alpha = 1) +
  cwd_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP4.5 End-century (2075-2099)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

cwd_ens85_near_plot <- ggplot() +
  geom_spatraster(data = clamp(cwd_ens85_near, lower = 100, values = NA), alpha = 1) +
  cwd_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP8.5 Near-future (2025-2049)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

cwd_ens85_mid_plot <- ggplot() +
  geom_spatraster(data = clamp(cwd_ens85_mid, lower = 100, values = NA), alpha = 1) +
  cwd_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP8.5 Mid-century (2050-2074)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

cwd_ens85_end_plot <- ggplot() +
  geom_spatraster(data = clamp(cwd_ens85_end, lower = 100, values = NA), alpha = 1) +
  cwd_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP8.5 End-century (2075-2099)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

ggarrange(
  cwd_ens45_near_plot, cwd_ens85_near_plot,
  cwd_ens45_mid_plot,  cwd_ens85_mid_plot,
  cwd_ens45_end_plot,  cwd_ens85_end_plot,
  ncol = 2,
  nrow = 3,
  common.legend = TRUE
)

```


```{r cwd-sd-plot, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 10, fig.width = 16, fig.cap = "Interannual Variability (SD) in ensemble mean annual CWD, End-Century (2075-2099)"}
cwd_ens45_sd_plot <- ggplot() +
  geom_spatraster(data = cwd_ens45_end_sd) +
  cwd_sd_scale +
  labs(title = "RCP4.5")

cwd_ens85_sd_plot <- ggplot() +
  geom_spatraster(data = cwd_ens85_end_sd) +
  cwd_sd_scale +
  labs(title = "RCP8.5")

ggarrange(cwd_ens45_sd_plot, cwd_ens85_sd_plot, common.legend = TRUE)
```

```{r aet-projections, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 16, fig.width = 12, out.width = '100%',  fig.cap = "Ensemble mean annual AET (mm), RCP4.5 and RCP8.5 scenarios."}
aet_ens45_near_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_ens45_near, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP4.5 Near-future (2025-2049)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

aet_ens45_mid_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_ens45_mid, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP4.5 Mid-century (2050-2074)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

aet_ens45_end_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_ens45_end, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP4.5 End-century (2075-2099)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

aet_ens85_near_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_ens85_near, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP8.5 Near-future (2025-2049)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

aet_ens85_mid_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_ens85_mid, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP8.5 Mid-century (2050-2074)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

aet_ens85_end_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_ens85_end, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP8.5 End-century (2075-2099)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

ggarrange(
  aet_ens45_near_plot, aet_ens85_near_plot,
  aet_ens45_mid_plot,  aet_ens85_mid_plot,
  aet_ens45_end_plot,  aet_ens85_end_plot,
  ncol = 2,
  nrow = 3,
  common.legend = TRUE
)
```

``` {r aet-sd-plot, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 10, fig.width = 16, fig.cap = "Interannual Variability (SD) in ensemble mean annual AET, End-Century (2075-2099)"}
aet_ens45_sd_plot <- ggplot() +
  geom_spatraster(data = aet_ens45_end_sd) +
  aet_sd_scale +
  labs(title = "RCP4.5 Interannual Variability in ensemble mean annual AET, End-Century (2075-2099)")

aet_ens85_sd_plot <- ggplot() +
  geom_spatraster(data = aet_ens85_end_sd) +
  aet_sd_scale +
  labs(title = "RCP8.5 Interannual Variability in ensemble mean annual AET, End-Century (2075-2099)")

ggarrange(aet_ens45_sd_plot, aet_ens85_sd_plot, common.legend = TRUE)
```

## Change from Baseline

``` {r cwd-baseline, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 16, out.width = '100%', fig.cap = "Ensemble mean CWD end-of-century (2075-2099) change from baseline (2002-2022)"}
cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_2022

cwd_45_change_plot <- ggplot() +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    cwd_change_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "CWD RCP4.5") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_rcp85_change_from_baseline <- cwd_ens85_end - cwd_2022

cwd_85_change_plot <- ggplot() +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp85_change_from_baseline, alpha = 1) +
    cwd_change_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "CWD RCP8.5") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggarrange(cwd_45_change_plot, cwd_85_change_plot, common.legend = TRUE)
```

``` {r aet-baseline, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 16, out.width = '100%', fig.cap = "Ensemble mean AET end-of-century (2075-2099) change from baseline (2002-2022)"}
## AET change from baseline

aet_rcp45_change_from_baseline <- aet_ens45_end - aet_2022

aet_45_change_plot <- ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    aet_change_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "AET RCP4.5") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


aet_rcp85_change_from_baseline <- aet_ens85_end - aet_2022

aet_85_change_plot <- ggplot() +
    ##    geom_spatraster(data = shade, show.legend = FALSE) +
    ##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = aet_rcp85_change_from_baseline, alpha = 1) +
    aet_change_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "AET RCP8.5") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggarrange(aet_45_change_plot, aet_85_change_plot, common.legend = TRUE)
```

| Scenario | AET Mean change from 2002-2022 Baseline          | CWD Mean change from 2002-2022 Baseline          |
|----------|--------------------------------------------------|--------------------------------------------------|
| RCP4.5   | `r global(mean(aet_rcp45_change_from_baseline))` | `r global(mean(cwd_rcp45_change_from_baseline))` |
| RCP8.5   | `r global(mean(aet_rcp85_change_from_baseline))` | `r global(mean(cwd_rcp85_change_from_baseline))` |



Summary of mean shifts in climate for historic and projected conditions:

| Year                | Mean AET                         | Mean CWD                         |
|---------------------|----------------------------------|----------------------------------|
| 1988 (Drought Year) | `r global(mean(aet_1988))`       | `r global(mean(cwd_1988))`       |
| 1982-2002           | `r global(mean(aet_2002))`       | `r global(mean(cwd_2002))`       |
| 2002-2022           | `r global(mean(aet_2022))`       | `r global(mean(cwd_2022))`       |
| RCP4.5 near         | `r global(mean(aet_ens45_near))` | `r global(mean(cwd_ens45_near))` |
| RCP8.5 near         | `r global(mean(aet_ens85_near))` | `r global(mean(cwd_ens85_near))` |
| RCP4.5 mid          | `r global(mean(aet_ens45_mid))`  | `r global(mean(cwd_ens45_mid))`  |
| RCP8.5 mid          | `r global(mean(aet_ens85_mid))`  | `r global(mean(cwd_ens85_mid))`  |
| RCP4.5 end          | `r global(mean(aet_ens45_end))`  | `r global(mean(cwd_ens45_end))`  |
| RCP8.5 end          | `r global(mean(aet_ens85_end))`  | `r global(mean(cwd_ens85_end))`  |


## Best Planting Sites
An algorithm to select the "best" planting locations based on this
data is presented here.  The 1,000,000 pixels with the highest AET and
1,000,000 pixels with the lowest CWD are selected.  Pixels that
overlap between these layers are selected, giving pixels that maximize
AET and minimize CWD, and decreasing selected pixels to around 200,000
or approximately 10-15% of the landscape here.  
``` {r best-plantings, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 20, fig.width = 10, out.width = '100%', fig.cap = "Locations that maximize AET and CWD for historical (2002-2022) and RCP4.5/RCP8.5 end-of-century projection ensembles.  n = number of pixels selected by algorithm, percentage shown is percentage of landscape identified by algorithm."}
n_sites <- 1000000

## (n_sites / ncell(elev)) * 100

highest_aet_historical <- selectHighest(aet_2022, n = n_sites)
lowest_cwd_historical <- selectHighest(cwd_2022, n = n_sites, low = TRUE)

best_sites_historical <- highest_aet_historical & lowest_cwd_historical

n_best_sites_historical <- zonal(best_sites_historical, best_sites_historical, length)[[2]]

## (n_best_sites / ncell(elev)) * 100

mean_aet_historical <- global(mask(aet_2022, highest_aet_historical), fun = "mean", na.rm = TRUE)
mean_cwd_historical <- global(mask(cwd_2022, lowest_cwd_historical), fun = "mean", na.rm = TRUE)

highest_aet_rcp45 <- selectHighest(aet_ens45_end, n = n_sites)
lowest_cwd_rcp45 <- selectHighest(cwd_ens45_end, n = n_sites, low = TRUE)

best_sites_rcp45 <- highest_aet_rcp45 & lowest_cwd_rcp45

n_best_sites_rcp45 <- zonal(best_sites_rcp45, best_sites_rcp45, length)[[2]]

## (n_best_sites / ncell(elev)) * 100

mean_aet_rcp45 <- global(mask(aet_ens45_end, highest_aet_rcp45), fun = "mean", na.rm = TRUE)
mean_cwd_rcp45 <- global(mask(cwd_ens45_end, lowest_cwd_rcp45), fun = "mean", na.rm = TRUE)


highest_aet_rcp85 <- selectHighest(aet_ens85_end, n = n_sites)
lowest_cwd_rcp85 <- selectHighest(cwd_ens85_end, n = n_sites, low = TRUE)

best_sites_rcp85 <- highest_aet_rcp85 & lowest_cwd_rcp85

n_best_sites_rcp85 <- zonal(best_sites_rcp85, best_sites_rcp85, length)[[2]]

## (n_best_sites / ncell(elev)) * 100

mean_aet_rcp85 <- global(mask(aet_ens85_end, highest_aet_rcp85), fun = "mean", na.rm = TRUE)
mean_cwd_rcp85 <- global(mask(cwd_ens85_end, lowest_cwd_rcp85), fun = "mean", na.rm = TRUE)


best_sites_historical_plot <- ggplot() +
  geom_spatraster(data = shade, show.legend = FALSE) +
  ##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
  scale_fill_gradientn(colors = pal_greys, na.value = NA) +
  ggnewscale::new_scale_fill() +
  geom_spatraster(data = best_sites_historical) +
  scale_fill_discrete(na.value = "transparent") +
  geom_sf(data = fs_roads, color = "orange", lwd = 1.5, alpha = 0.5) +
  geom_sf_text(data = fs_roads, aes(label = ID), alpha = 0.9) +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), alpha = 0.4) +
  labs(title = glue::glue("Historical (2002-2022), n = {n_best_sites_historical}, {round(n_best_sites_historical * 100 / ncell(elev), 2)}%")) +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

best_sites_rcp45_plot <- ggplot() +
  geom_spatraster(data = shade, show.legend = FALSE) +
  ##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
  scale_fill_gradientn(colors = pal_greys, na.value = NA) +
  ggnewscale::new_scale_fill() +
  geom_spatraster(data = best_sites_rcp45) +
  scale_fill_discrete(na.value = "transparent") +
  geom_sf(data = fs_roads, color = "orange", lwd = 1.5, alpha = 0.5) +
  geom_sf_text(data = fs_roads, aes(label = ID), alpha = 0.9) +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), alpha = 0.4) +
  labs(title = glue::glue("RCP4.5 End of Century n = {n_best_sites_rcp45}, {round(n_best_sites_rcp45 * 100 / ncell(elev), 2)}%")) +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

best_sites_rcp85_plot <- ggplot() +
  geom_spatraster(data = shade, show.legend = FALSE) +
  ##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
  scale_fill_gradientn(colors = pal_greys, na.value = NA) +
  ggnewscale::new_scale_fill() +
  geom_spatraster(data = best_sites_rcp85) +
  scale_fill_discrete(na.value = "transparent") +
  geom_sf(data = fs_roads, color = "orange", lwd = 1.5, alpha = 0.5) +
  geom_sf_text(data = fs_roads, aes(label = ID), alpha = 0.9) +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), alpha = 0.4) +
  labs(title = glue::glue("RCP8.5 End of Century n = {n_best_sites_rcp85}, {round(n_best_sites_rcp85 * 100 / ncell(elev), 2)}%")) +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

## bind_cols(units,
##     sum_area_best_sites = zonal(best_sites, vect(units), fun = "sum", na.rm = TRUE)[[1]]
## ) %>%
##     as_tibble() %>%
##     select(Unit, sum_area_best_sites) %>%
##     knitr::kable(digits = 2)

ggarrange(best_sites_historical_plot, best_sites_rcp45_plot, best_sites_rcp85_plot,
    ncol = 1
)

```
This algorithm identifies areas of the landscape that are ideal based on the criteria of maximizing AET and minimizing CWD, relative to other pixels in the landscape for the same time period.  Much of the area identified by this algorithm in the based on conditions over the past twenty years is likely to remain the areas that maximize AET and minimize CWD under projected climatic conditions at the end of the century (Figure \@ref(fig:best-plantings)).  However, widespread warming under climate projections will also affect these areas, and they will likely experience increases in both annual AET and Deficit by the end of the century as will the rest of the landscape.  

Average conditions of "ideal pixels" (red pixels in Figure \@ref(fig:best-plantings)) in historic, RCP4.5 and RCP8.5 scenarios:

| Scenario | Mean AET                | Mean CWD                |
|----------|-------------------------|-------------------------|
| Historic | `r mean_aet_historical` | `r mean_cwd_historical` |
| RCP4.5   | `r mean_aet_rcp45`      | `r mean_cwd_rcp45`      |
| RCP8.5   | `r mean_aet_rcp85`      | `r mean_cwd_rcp85`      |


# Discussion

# Limitations
Snow accumulation and melt were modeled at the scale of the entire
site, and was not downscaled based on topography.  In reality, snow
accumulation and melt is affected by factors such as slope, aspect, as
well as horizontal movement through snow drift.  Future analyses could
incorporate the high-resolution topographic data used here to improve
accuracy of snow melt and accumulation dynamics at fine scales.

Temperature and precipitation data were applied uniformly across all
pixels in the site.  However, temperature is affected by changes in
elevation and this can impact the accuracy of modeled water balance
metrics.  Future analyses could incorporate temperature corrections
based on lapse rate to improve accuracy of modeled metrics that are
temperature-sensitive [@tercekCorrectlyApplyingLapse2021].

Soil survey data provided by the SSURGO database is intended to be
used at scales of 1:24,000.  There is likely considerable variation in
the soil characteristics observed at the fine spatial scales analyzed
here that is not captured in these surveys.  Planting decisions made
using this data should consider observed soil characteristics in the
field in conjunction with data presented here.

# TODO

- 3d Maps
- Other ways to identify ideal planting locations.  What criteria are Nancy/planting crews looking for?

# Acknowledgments
Computational efforts were performed on the [Tempest High Performance
Computing System](https://www.montana.edu/uit/rci/tempest/), operated and supported by University Information
Technology Research Cyberinfrastructure at Montana State University.

# References

<!-- Local Variables: -->
<!-- jinx-local-words: "ncell" -->
<!-- End: -->
