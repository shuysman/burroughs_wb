---
title: 'Burroughs Creek (Shoshone National Forest) WBP Planting Microsite Analysis'
author: 
  - Stephen Huysman, shuysman@gmail.com
email: "shuysman@gmail.com"
date: "`r Sys.Date()`"
bibliography: library.bib
csl: global-ecology-and-biogeography.csl
link-citations: true
output:
  bookdown::html_document2:
    theme: cerulean
    number_sections: true
    toc: true
---

```{css, echo=FALSE}
/* body .main-container { */
/*     max-width: 2000px !important; */
/*     width: 1080px !important; */
/* } */
/* body { */
/*     max-width: 2000px !important; */
/* } */
```

``` {r setup, include = FALSE}
library(tidyverse)
library(sf)
library(terra)
library(tidyterra)
library(ggnewscale)
library(ggspatial)
library(ggpubr)
library(kableExtra)

options(digits = 2)
terraOptions(verbose = FALSE,
             memfrac = 0.9)

elev <- rast("./data/burroughs_creek_USGS1m_clipped_nad83.tif") 
aspect <- rast("./data/planting_unit_aspect.tif")
slope <- rast("./data/planting_unit_slope.tif")
shade <- rast("./data/burroughs_creek_USGS1m_clipped_hillshade_nad83.tif")
soil <- rast("./data/soil_whc_025_aligned_clipped.tif") %>% round(2) %>% clamp(lower = 0, values = NA)

pal_greys <- hcl.colors(1000, "Grays")

units <- st_read("./data/units/Possible_WBP_Units_Nancy_Updated.shp") %>% st_cast("MULTIPOLYGON")

##  Generate fs roads gpkg with only burroughs roads
## fs_roads <- st_read("./data/fs_roads/S_USA.RoadCore_FS.shp")

## elev2 <- project(elev, crs(fs_roads))
## bbox <- st_bbox(elev2) %>% st_as_sfc()
## fs_roads <- st_intersection(fs_roads, bbox)

## st_write(fs_roads, "./data/fs_roads_burroughs.gpkg")

fs_roads <- st_read("./data/fs_roads_burroughs.gpkg")

stats <- data.frame(elev_mean = zonal(elev, vect(units), fun = "mean")[[1]],
                         elev_max = zonal(elev, vect(units), fun = "max")[[1]],
                         elev_min = zonal(elev, vect(units), fun = "min")[[1]],
                         slope_mean = zonal(slope, vect(units), fun = "mean", na.rm = TRUE)[[1]],
                         slope_max = zonal(slope, vect(units), fun = "max", na.rm = TRUE)[[1]],
                         slope_min = zonal(slope, vect(units), fun = "min", na.rm = TRUE)[[1]],
                         aspect_mean = zonal(aspect, vect(units), fun = "mean", na.rm = TRUE)[[1]]
                    )

units <- bind_cols(units, stats)
```

``` {r plot-settings, include = FALSE}
## Change from baseline plots
aet_change_scale <-
    scale_fill_viridis_c(option = "G", limits = c(0, 200))

cwd_change_scale <-
    scale_fill_viridis_c(option = "F", limits = c(0, 200))

aet_scale <-
    scale_fill_viridis_c(option = "D", limits = c(50, 500))

cwd_scale <-
  scale_fill_viridis_c(option = "B", limits = c(0, 550))

aet_sd_scale <-
    scale_fill_viridis_c(option = "A", limits = c(0, 15))

cwd_sd_scale <-
    scale_fill_viridis_c(option = "C", limits = c(0, 30))
```

# Introduction
This report presents historical (1979-2022) and projected (2006-2099)
water balance for the Burroughs Creek site (Figure \@ref(fig:planting-units)) in the Shoshone National
Forest.  This location was selected to plant whitebark pine (*Pinus
albicaulis*) seedlings in summer 2024.  The site previously burned in
August 30, 2013 in the Burroughs wildfire (MTBS ID
`wy4368810966320130830`).  The vegetation composition of the site
prior to the burn is unknown, but is assumed to have sustained
populations of whitebark pine.  Current satellite imagery shows that
the Burroughs wildfire cleared most trees from the site, with some
remnant trees persisting in sheltered locations.

This report applies the climatic water balance to the Burroughs Creek
site at a fine spatial scale to make recommendations of ideal planting
locations. Potential Evapotranspiration (PET) represents the potential
for plant growth given available energy if not limited by water
availability.  Actual Evapotranspiration (AET) is a measure of total
evaporative loss to the atmosphere, and is well-correlated with
measures of plant growth such as primary productivity.  The difference
between PET and AET is the Climatic Water Deficit (CWD), which
measures evaporative demand unmet by available water.  AET represents
the length and magnitude of growing conditions favorable to plants
while CWD provides a measure of drought stress.  The bivariate
relationship between AET and CWD is a robust tool to characterize the
biophysical environment of plants and has been shown to be
well-correlated with vegetation distributions across ten orders of
spatial magnitude
[@stephensonClimaticControlVegetation1990;@stephensonActualEvapotranspirationDeficit1998].

Fine-scale variation in topography and soil features has been shown to
strongly affect modeled water balance
[@dyerGISBasedWaterBalance2019]. These fine-scale variations in water
balance are intuitively understood by planters, who often select
planting locations based on microsite features such as presence of
logs or boulders that provide shade, decreasing evaporative demands.
Our objective was to use historical and projected climate data to
model the climatic water balance of the Burroughs Creek site using the
highest resolution topographic and soil survey data available to
understand fine-scale spatial variation in the climatic water balance
across the site in order to facilitate identification of suitable
planting microsites and guide planting of whitebark pine seedlings.
As whitebark pine is a long-lived tree species that reaches
reproductive age around 50 years in ideal conditions, successful
whitebark plantings require a consideration of both present and future
climatic conditions.

In general, desirable planting locations will have higher AET, to
promote rapid plant establishment and growth, and lower CWD, to
minimize drought stress and fire risk
[@thomaWaterBalanceIndicator2020].  Depending on management objects,
optimal site characteristics can vary and these results can be
interpreted in different ways.  For example, if management goals are
to:

1. Maximize successful establishment of seedlings - planters should
       choose planting locations that maximize AET to achieve higher
       seedling growth rates and minimize CWD to reduce drought
       stress.  Previous work has identified fastest growth rates in
       whitebark seedlings above an annual AET around 350 mm
       [@laufenbergBiophysicalGradientsPerformance2020].  Although
       direct comparisons with this work cannot be made without bias
       correction between the different climate data sets used, in
       general higher AET can be assumed to correlate with faster
       seedling growth and establishment.
2. Grow trees to cone-bearing age as quickly as possible - choose
       planting locations that maximize AET over the duration needed
       for trees to reach reproductive age, approximately 25-50 years.
3. Maximize longevity of adult trees - select planting locations that
       minimize interannual variability in stressors.  It is thought
       that trees can survive unfavorable conditions if they are
       adapted to them, and extreme swings in climatic conditions
       cause mortality in trees that are not adapted to those extremes
       (M. Tercek, personal communication, June 4, 2024).

Color scales used for maps are kept the same for each variable (AET,
CWD) throughout this report, so direct comparisons can be made between
maps for the same variable made for different periods of time.

## Topography

```{r planting-units, fig.cap = "Burroughs Creek Planting Units, with hillshade and USFS roads.", fig.height = 8, fig.width = 10, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE}
ggplot() +
    geom_spatraster(data = shade, show.legend = FALSE) +
##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    geom_sf(data = fs_roads, color = "orange", lwd = 1.5, alpha = 0.5) +
    geom_sf_text(data = fs_roads, aes(label = ID), alpha = 0.9) +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), alpha = 0.4) +
    labs(title = "Burroughs WBP Planting Units Hillshade") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
```

``` {r planting-unit-statistics,  warning = FALSE, message = FALSE, echo = FALSE}
knitr::kable(
    select(as_tibble(units),
        Unit,
        Description = DESCRIPTIO,
        Acres = ACRES,
        elev_mean,
        elev_max,
        elev_min,
        slope_mean,
        slope_max,
        slope_min,
        aspect_mean
    ),
    digits = 2,
    caption = "Topographic Statistics of Burroughs Creek planting units")
```

##  Soils
``` {r soils, fig.height = 8, fig.width = 10, out.width = '100%', warning = FALSE, message = FALSE, echo = FALSE, fig.cap = "Burroughs Creek soil water holding capacity (WHC, mm).  WHC is taken from the SSURGO available water storage at 25 cm soil depth layer"}
ggplot() +
    geom_spatraster(data = soil) +
    labs(title = "Burroughs WBP Planting Unit Soil WHC (mm) to 25cm soil depth") +
    scale_fill_viridis_b() +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
```

Soils range from `r global(soil, min, na.rm = TRUE)[[1]]` to `r global(soil, max, na.rm = TRUE)[[1]]` mm whc at 25 cm soil depth
(Figure \@ref(fig:soils)). Soil water capacity at 25 cm was selected
because the application of this report is for planting seedlings and
mature whitebark pine trees typically have shallow root systems not
typically penetrating more than 30cm of soil
(https://www.fs.usda.gov/database/feis/plants/tree/pinalb/all.html).
Soils in the WB2 unit hold approximately 8 mm more water on average
(Table \@ref(tab:soils-zonals)).

``` {r soils-zonals, echo = FALSE}
zonal(soil, vect(units), fun = "mean", na.rm = TRUE) %>%
    cbind(Unit = units$Unit, .) %>%
    knitr::kable(digits = 2, col.names = c("Unit", "Mean Soil WHC (mm)"), caption = "Average soil WHC (mm)")
```

The SSURGO soil automated report for the site can be read here [20240514_11420911928_90_Soil_Report.pdf](./20240514_11420911928_90_Soil_Report.pdf "20240514_11420911928_90_Soil_Report.pdf").

## Climate space of WBP

``` {r climate-space, fig.height = 10, fig.width = 10, warning = FALSE, message = FALSE, echo = FALSE, fig.cap = "Bioclimatic niche space of WBP.  WBP occurrence points taken from NPS white pine blister rust monitoring data set.  WBP occurences within the Greater Yellowstone Ecosystem are highlighted in light blue. AET and CWD values are sampled from the 1 km. NPS Gridded Water Balance model summary layers (http://screenedcleanedsummaries.s3-website-us-west-2.amazonaws.com/).  Historical and RCP4.5/RCP8.5 projections for AET and CWD for a point in the Burroughs Creek site (43.7061975, -109.6778113) were also sampled from the NPS Gridded Water Balance model summary layers and displayed using a + symbol. Projections are ensemble averages of CMIP5 models. Note that AET and CWD values in the NPS Gridded Water Balance product were calculated using different model parameters (soil WHC, topography) and should not be compared to the 1m water balance model presented here."}
library(plotly)
library(gghighlight)

burroughs_ck <- c(-109.6778113, 43.7061975)

aet_summary_dir <- file.path("/media/smithers/shuysman/data/nps_gridded_wb/summary_layers/AET/")
cwd_summary_dir <- file.path("/media/smithers/shuysman/data/nps_gridded_wb/summary_layers/Deficit/")

aet <- rast(file.path(aet_summary_dir, "historical/V_1_5_annual_gridmet_historical_AET_2000_2019_annual_means_cropped_units_mm.tif"))
names(aet) <- "AET"
cwd <- rast(file.path(cwd_summary_dir, "historical/V_1_5_annual_gridmet_historical_Deficit_2000_2019_annual_means_cropped_units_mm.tif"))
names(cwd) <- "CWD"
aet_45 <- rast(file.path(aet_summary_dir, "rcp45/ensembles/ensemble_2070_2099_annual_rcp45_AET_units_mm.tif"))
names(aet_45) <- "AET_45"
cwd_45 <- rast(file.path(cwd_summary_dir, "rcp45/ensembles/ensemble_2070_2099_annual_rcp45_Deficit_units_mm.tif"))
names(cwd_45) <- "CWD_45"
aet_85 <- rast(file.path(aet_summary_dir, "rcp85/ensembles/ensemble_2070_2099_annual_rcp85_AET_units_mm.tif"))
names(aet_85) <- "AET_85"
cwd_85 <- rast(file.path(cwd_summary_dir, "rcp85/ensembles/ensemble_2070_2099_annual_rcp85_Deficit_units_mm.tif"))
names(cwd_85) <- "CWD_85"

wbp_points <- read_csv("/home/steve/OneDrive/whitebark/blister-rust/ej/SITE_LOCATIONS.csv") %>%
  bind_rows(tibble(network = "burroughs", park = "burroughs", long = burroughs_ck[1], lat = burroughs_ck[2])) %>%
  drop_na(c("lat", "long")) %>%
  st_as_sf(coords = c("long", "lat"), crs = st_crs("EPSG:4326")) %>%
  st_transform(crs = st_crs(aet))

wbp_points <- extract(aet, wbp_points, bind = TRUE)
wbp_points <- extract(cwd, wbp_points, bind = TRUE)
wbp_points <- extract(aet_45, wbp_points, bind = TRUE)
wbp_points <- extract(cwd_45, wbp_points, bind = TRUE)
wbp_points <- extract(aet_85, wbp_points, bind = TRUE)
wbp_points <- extract(cwd_85, wbp_points, bind = TRUE)

## wbp_plot <- ggplot(wbp_points) +
##     geom_point(aes(x = CWD, y = AET, color = park)) +
##     labs(title = "WBP Bioclimatic Niche")
## ggplotly(wbp_plot)

ggplot(wbp_points) +
    geom_point(aes(x = CWD, y = AET, color = park)) +
    ## geom_point(aes(x = 179.89, 192.98), color = "blue", shape = 3, size = 10) +
    ## geom_text(aes(x = 179.89, 192.98), color = "blue", label = "historic") +
    ## geom_point(aes(x = 235.81, 247.61), color = "green", shape = 2, size = 10) +
    ## geom_text(aes(x = 235.81, 247.61), color = "green", label = "rcp4.5") +
    ## geom_point(aes(x = 306.32, 287.88), color = "red", shape = 2, size = 10) +
  ## geom_text(aes(x = 306.32, 287.88), color = "red", label = "rcp8.5") +
  geom_point(shape = "+", size = 10, data = filter(wbp_points, park == "burroughs"), aes(x = CWD, y = AET), color = "green") +
  geom_point(shape = "+", size = 10, data = filter(wbp_points, park == "burroughs"), aes(x = CWD_45, y = AET_45), color = "red") +
  geom_point(shape = "+", size = 10, data = filter(wbp_points, park == "burroughs"), aes(x = CWD_85, y = AET_85), color = "orange") +
  geom_text(data = filter(wbp_points, park == "burroughs"), aes(x = CWD, y = AET), label = "Historical", nudge_y = 2, size = 6) +
  geom_text(data = filter(wbp_points, park == "burroughs"), aes(x = CWD_45, y = AET_45), label = "4.5", nudge_y = 2, size = 6) +
  geom_text(data = filter(wbp_points, park == "burroughs"), aes(x = CWD_85, y = AET_85), label = "8.5", nudge_y = 2, size = 6) +
  gghighlight(park %in% c("GYE", "burroughs")) +
  labs(title = "WBP Bioclimatic Niche (GYE)")


```

# Methods
A Thornthwaite-style water balance model
[@thornthwaiteApproachRationalClassification1948] was run at a
daily-time step for the area within the bounding box of the planting
units. Topographic and elevation data was provided by the 1-meter
LiDAR digital elevation model (DEM) provided by the USGS 3DEP
[@u.s.geologicalsurveyWYFEMAEast2020].  Slope and aspect were
calculated from the 3DEP DEM using tools provided in QGIS
[@QGIS_software].  

Soil water holding capacity (WHC) was estimated using the 'available
water storage from 0-25cm' (`aws025wta`) data provided by the SSURGO
database
[@naturalresourcesconservationserviceSoilSurveyGeographic2015].  A 1 m
raster was generated from the WHC data in QGIS using the 1 m DEM
raster as a reference for sampling grid cells.  

Historical climate data (maximum temperature, minimum temperature,
precipitation) from 1979-2022 was provided by the gridMET dataset at a
daily timestep and 4 km resolution
[@abatzoglouDevelopmentGriddedSurface2013].  Projected climate data
for the same variables was provided by the MACA data set at the same
timestep and spatial resolution
[@abatzoglouComparisonStatisticalDownscaling2012].  The MACA dataset
was downscaled using gridMET, so time series between 1979 and 2099 are
commensurate with no breaks between past and future. The historical
and projected climate grids were reprojected and resampled to the same
CRS, extent, and resolution as the 1 m DEM raster.

Four CMIP5 GCMs for RCP4.5 and RCP8.5 scenarios were selected to
bracket plausible future conditions. GCM/Scenario combinations that
represented warm wet, hot wet, warm dry, and hot dry conditions in
Yellowstone National Park (representing conditions in the larger GYE)
were selected based on projected changes in annual temperature and
precipitation by 2050 (Data from Mike Tercek, do we have a citation
for this?).  The four GCM and Scenario combinations selected to
represent plausible future conditions at the Burroughs Creek site are
shown in table \@ref(tab:GCM-table).

Table (\#tab:GCM-table): GCM and emission scenarios representing Warm
Wet, Hot Wet, Warm Dry, and Hot Dry conditions, bracketing the range
of plausible climate futures at the site.
| Future   | GCM           | Scenario |
|----------|---------------|----------|
| Warm Wet | MRI-CGCM3     | RCP8.5   |
| Hot Wet  | CanESM2       | RCP8.5   |
| Warm Dry | MRI-CGCM3     | RCP4.5   |
| Hot Dry  | HadGEM2-CC365 | RCP8.5   |

The Burroughs Creek site is much smaller in scale than the 4 km grid
cells, and falls at the center of the intersection of four grid cells.
To remove spatial discontinuities in the modeled water balance for the
site, the grid cell with an elevation closest to the mean elevation
for the site was selected and climate data from this grid cell was applied across the site.  

The daily water balance at a 1m resolution was modeled using a
modified version of the script used to generate the NPS 1 km Gridded
Water Balance product for the coterminous United States
[@tercekHistoricalChangesPlant2021].  PET was calculated following @oudinEstimatingPotentialEvapotranspiration2010.
Annual sums of AET (mm) and Deficit (mm) were calculated for the
historical dataset as well as for each GCM/Scenario combination.
Ensemble averages for annual sums of AET and Deficit were created.

For comparisons with projected conditions, annual AET and CWD sums
between 2002-2022 were averaged to use as current baseline conditions.
Projections were summarized in near-term (2025-2049), mid-century
(2050-2075), and end-century (2076-2099) periods.

# Results

## Historical Water Balance

Mean annual sums of AET and CWD for periods from 1982-2002 and 2002-2022 are shown here.  Annual AET and CWD sums for 1988 are shown as an example of a drought year (1988 Yellowstone Wildfires). Refer to table \@ref(tab:climate-summary) for summary of historical and projected climate conditions.

``` {r historical, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 10, out.width = '100%'}
gridmet_data_dir <- file.path("~/out/sums/")

aet <- rast(file.path(gridmet_data_dir, "historical_gridmet_AET_annual_sum_burroughs.nc")) |>
    clamp(lower = 0, values = NA) / 10
cwd <- rast(file.path(gridmet_data_dir, "historical_gridmet_Deficit_annual_sum_burroughs.nc")) |>
    clamp(lower = 0, values = NA) / 10


### 1988 Drought Year
aet_1988 <- aet %>% subset(year(time(.)) == 1988)
cwd_1988 <- cwd %>% subset(year(time(.)) == 1988)

### Previous 20 years before current
aet_2002 <- aet %>% subset(year(time(.)) >= 1982 & year(time(.)) <= 2002) %>% mean()
cwd_2002 <- cwd %>% subset(year(time(.)) >= 1982 & year(time(.)) <= 2002) %>% mean()

### Last 20 years
aet_2022 <- aet %>% subset(year(time(.)) >= 2002 & year(time(.)) <= 2022) %>% mean()
cwd_2022 <- cwd %>% subset(year(time(.)) >= 2002 & year(time(.)) <= 2022) %>% mean()

years = c(1988, 2002, 2022)
vars = c("aet", "cwd")
types = c("mean", "min", "max")

unit_stats <- tibble()
for (year in years) {
    for (var in vars) {
        for (type in types) {
            unit_stats <- bind_rows(unit_stats,
                               bind_cols(year = year,
                                         var = var,
                                         type = type,
                                         value = zonal(get(glue::glue("{var}_{year}")), vect(units), fun = type, na.rm = TRUE)[[1]]))
        }
    }
}

unit_stats <- bind_cols(unit = rep(units$Unit, nrow(unit_stats) / 2), unit_stats)

## unit_stats %>% pivot_wider(id_cols = c(unit, year, var),
##                             names_from = type,
##                            values_from = value) %>%
##     ggplot(aes(x = year, y = mean, color = unit)) +
##     geom_line() +
##     geom_ribbon(aes(ymin = min, ymax = max, fill = unit), linetype = "dashed", alpha = 0.1) +
##     ##geom_linerange(aes(x = year, y = mean, ymin = min, ymax = max), color = unit) +
##     facet_wrap(~var)

## unit_stats %>% pivot_longer(cols = starts_with(c("aet"))) %>%
##     ggplot() +
##     geom_line(aes(x = name, y = value, group = Unit, color = Unit)) +
##     labs(title = "Change in AET normals vs 1988 drought year")

## unit_stats %>% pivot_longer(cols = starts_with(c("cwd"))) %>%
##     ggplot() +
##     geom_line(aes(x = name, y = value, group = Unit, color = Unit)) +
##     labs(title = "Change in CWD normals vs 1988 drought year")

aet_2002_plot <- ggplot() +
    geom_spatraster(data = aet_2002, alpha = 1) +
    aet_scale + 
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1982-2002") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_2002_plot <- ggplot() +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data =cwd_2002, alpha = 1) +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "1982-2002") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


aet_2022_plot <- ggplot() +
    geom_spatraster(data = aet_2022, alpha = 1) +
    aet_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "2002-2022") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
##ggsave("burroughs_2002-2022_aet.png", width=16, height=12)


cwd_2022_plot <- ggplot() +
    geom_spatraster(data = cwd_2022, alpha = 1) +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "2002-2022") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
##ggsave("burroughs_2002-2022_deficit.png", width=16, height=12)



aet_1988_plot <- ggplot() +
    geom_spatraster(data = aet_1988, alpha = 1) +
    theme(legend.position="bottom") +
    aet_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "AET (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


cwd_1988_plot <- ggplot() +
    geom_spatraster(data = cwd_1988, alpha = 1) +
    theme(legend.position="bottom") +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "CWD (mm)") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))
```

``` {r historical-aet-plot, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 16, out.width = '100%', fig.cap = "Historical AET (mm)"}
ggarrange(aet_2002_plot, aet_2022_plot, common.legend = TRUE) %>%
    annotate_figure(top = text_grob("Historical annual AET (mm)", size = 14, face = "bold"))
```

``` {r historical-cwd-plot, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 16, out.width = '100%', fig.cap = "Historical CWD (mm)"} 
ggarrange(cwd_2002_plot, cwd_2022_plot, common.legend = TRUE) %>%
    annotate_figure(top = text_grob("Historical annual CWD (mm)", size = 14, face = "bold"))
```

``` {r drought-year-plot, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 16, out.width = '100%', fig.cap = "Drought Year Conditions (1988)"}
ggarrange(aet_1988_plot, cwd_1988_plot) %>%
    annotate_figure(top = text_grob("Dought Year (1988)", size = 14, face = "bold"))
```

## Projected Water Balance

Projected mean annual AET and CWD are shown for three time periods:

1. Near-term: 2025-2049
2. Mid-century: 2050-2074
3. End-of-century: 2075-2099

The standard deviation in mean annual CWD for the end-of-century
(2075-2099) projections is shown as a measure of interannual
variability in CWD.

``` {r projections-setup, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 10, out.width = '100%'}
current <- 2006:2024
near <- 2025:2049
mid <- 2050:2074
end <- 2075:2099

ens_dir <- file.path("/media/smithers/shuysman/data/burroughs/sums/ensembles/")

cwd_ens45 <- rast(file.path(ens_dir, "ensemble_rcp45_Deficit_annual_sum_burroughs.nc")) %>%
  clamp(lower = 0, values = NA) / 10

cwd_ens45_near <- cwd_ens45 %>% subset(year(time(.)) %in% near) %>% mean()
cwd_ens45_mid <- cwd_ens45 %>% subset(year(time(.)) %in% mid) %>% mean()
cwd_ens45_end <- cwd_ens45 %>% subset(year(time(.)) %in% end) %>% mean()

cwd_ens85 <- rast(file.path(ens_dir, "ensemble_rcp85_Deficit_annual_sum_burroughs.nc")) %>%
  clamp(lower = 0, values = NA) / 10

cwd_ens85_near <- cwd_ens85 %>% subset(year(time(.)) %in% near) %>% mean()
cwd_ens85_mid <- cwd_ens85 %>% subset(year(time(.)) %in% mid) %>% mean()
cwd_ens85_end <- cwd_ens85 %>% subset(year(time(.)) %in% end) %>% mean()

aet_ens45 <- rast(file.path(ens_dir, "ensemble_rcp45_AET_annual_sum_burroughs.nc")) %>%
  clamp(lower = 0, values = NA) / 10

aet_ens45_near <- aet_ens45 %>% subset(year(time(.)) %in% near) %>% mean()
aet_ens45_mid <- aet_ens45 %>% subset(year(time(.)) %in% mid) %>% mean()
aet_ens45_end <- aet_ens45 %>% subset(year(time(.)) %in% end) %>% mean()

aet_ens85 <- rast(file.path(ens_dir, "ensemble_rcp85_AET_annual_sum_burroughs.nc")) %>%
  clamp(lower = 0, values = NA) / 10

aet_ens85_near <- aet_ens85 %>% subset(year(time(.)) %in% near) %>% mean()
aet_ens85_mid <- aet_ens85 %>% subset(year(time(.)) %in% mid) %>% mean()
aet_ens85_end <- aet_ens85 %>% subset(year(time(.)) %in% end) %>% mean()


aet_ens45_end_sd <- aet_ens45 %>%
  subset(year(time(.)) %in% end) %>%
  stdev()
aet_ens85_end_sd <- aet_ens85 %>%
  subset(year(time(.)) %in% end) %>%
  stdev()

cwd_ens45_end_sd <- cwd_ens45 %>%
  subset(year(time(.)) %in% end) %>%
  stdev()
cwd_ens85_end_sd <- cwd_ens85 %>%
    subset(year(time(.)) %in% end) %>%
  stdev()

```

```{r cwd-projections, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 16, fig.width = 12, out.width = '100%', fig.cap = "Ensemble mean annual CWD (mm), RCP4.5 and RCP8.5 scenarios."}
cwd_ens45_near_plot <- ggplot() +
  geom_spatraster(data = clamp(cwd_ens45_near, lower = 100, values = NA), alpha = 1) +
  cwd_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP4.5 Near-future (2025-2049)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

cwd_ens45_mid_plot <- ggplot() +
  geom_spatraster(data = clamp(cwd_ens45_mid, lower = 100, values = NA), alpha = 1) +
  cwd_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP4.5 Mid-century (2050-2074)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

cwd_ens45_end_plot <- ggplot() +
  geom_spatraster(data = clamp(cwd_ens45_end, lower = 100, values = NA), alpha = 1) +
  cwd_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP4.5 End-century (2075-2099)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

cwd_ens85_near_plot <- ggplot() +
  geom_spatraster(data = clamp(cwd_ens85_near, lower = 100, values = NA), alpha = 1) +
  cwd_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP8.5 Near-future (2025-2049)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

cwd_ens85_mid_plot <- ggplot() +
  geom_spatraster(data = clamp(cwd_ens85_mid, lower = 100, values = NA), alpha = 1) +
  cwd_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP8.5 Mid-century (2050-2074)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

cwd_ens85_end_plot <- ggplot() +
  geom_spatraster(data = clamp(cwd_ens85_end, lower = 100, values = NA), alpha = 1) +
  cwd_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP8.5 End-century (2075-2099)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

ggarrange(
    cwd_ens45_near_plot, cwd_ens85_near_plot,
    cwd_ens45_mid_plot,  cwd_ens85_mid_plot,
    cwd_ens45_end_plot,  cwd_ens85_end_plot,
    ncol = 2,
    nrow = 3,
    common.legend = TRUE
) %>%
    annotate_figure(top = text_grob("Projected annual CWD mean (mm)", size = 14, face = "bold"))

```


```{r cwd-sd-plot, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 10, fig.width = 16, fig.cap = "Interannual Variability (SD) in ensemble mean annual CWD, End-Century (2075-2099)"}
cwd_ens45_sd_plot <- ggplot() +
  geom_spatraster(data = cwd_ens45_end_sd) +
  cwd_sd_scale +
  labs(title = "RCP4.5")

cwd_ens85_sd_plot <- ggplot() +
  geom_spatraster(data = cwd_ens85_end_sd) +
  cwd_sd_scale +
  labs(title = "RCP8.5")

ggarrange(cwd_ens45_sd_plot, cwd_ens85_sd_plot, common.legend = TRUE) %>%
    annotate_figure(top = text_grob("Projected annual CWD SD (mm)", size = 14, face = "bold"))
```

```{r aet-projections, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 16, fig.width = 12, out.width = '100%',  fig.cap = "Ensemble mean annual AET (mm), RCP4.5 and RCP8.5 scenarios."}
aet_ens45_near_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_ens45_near, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP4.5 Near-future (2025-2049)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

aet_ens45_mid_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_ens45_mid, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP4.5 Mid-century (2050-2074)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

aet_ens45_end_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_ens45_end, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP4.5 End-century (2075-2099)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

aet_ens85_near_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_ens85_near, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP8.5 Near-future (2025-2049)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

aet_ens85_mid_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_ens85_mid, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP8.5 Mid-century (2050-2074)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

aet_ens85_end_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_ens85_end, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "RCP8.5 End-century (2075-2099)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

ggarrange(
    aet_ens45_near_plot, aet_ens85_near_plot,
    aet_ens45_mid_plot,  aet_ens85_mid_plot,
    aet_ens45_end_plot,  aet_ens85_end_plot,
    ncol = 2,
    nrow = 3,
    common.legend = TRUE
) %>%
    annotate_figure(top = text_grob("Projected annual AET mean (mm)", size = 14, face = "bold"))
```

``` {r aet-sd-plot, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 10, fig.width = 16, fig.cap = "Interannual Variability (SD) in ensemble mean annual AET, End-Century (2075-2099)"}
aet_ens45_sd_plot <- ggplot() +
  geom_spatraster(data = aet_ens45_end_sd) +
  aet_sd_scale +
  labs(title = "RCP4.5 Interannual Variability in ensemble mean annual AET, End-Century (2075-2099)")

aet_ens85_sd_plot <- ggplot() +
  geom_spatraster(data = aet_ens85_end_sd) +
  aet_sd_scale +
  labs(title = "RCP8.5 Interannual Variability in ensemble mean annual AET, End-Century (2075-2099)")

ggarrange(aet_ens45_sd_plot, aet_ens85_sd_plot, common.legend = TRUE) %>%
    annotate_figure(top = text_grob("Projected annual AET SD (mm)", size = 14, face = "bold"))

```

| Future   | GCM           | Scenario |
|----------|---------------|----------|
| Warm Wet | MRI-CGCM3     | RCP8.5   |
| Hot Wet  | CanESM2       | RCP8.5   |
| Warm Dry | MRI-CGCM3     | RCP4.5   |
| Hot Dry  | HadGEM2-CC365 | RCP8.5   |

``` {r projections-new}
current <- 2006:2024
near <- 2025:2049
mid <- 2050:2074
end <- 2075:2099

proj_dir <- file.path("/media/smithers/shuysman/data/burroughs/sums/")

load_gcm <- function(filename) {
    r <- rast(filename) %>%
        subset(year(time(.)) %in% end) %>% ## Limit to end-century conditions
        mean() %>%
        clamp(lower = 0, values = NA) / 10 ## remove NAs and divide by ten (nps gridded wb is provided in units x 10)
    return(r)
}

aet_warm_wet <- load_gcm(file.path(proj_dir, "MRI-CGCM3_rcp85_AET_annual_sum_burroughs.nc"))
cwd_warm_wet <- load_gcm(file.path(proj_dir, "MRI-CGCM3_rcp85_Deficit_annual_sum_burroughs.nc"))

aet_hot_wet <- load_gcm(file.path(proj_dir, "CanESM2_rcp85_AET_annual_sum_burroughs.nc")) 
cwd_hot_wet <- load_gcm(file.path(proj_dir, "CanESM2_rcp85_Deficit_annual_sum_burroughs.nc"))

aet_warm_dry <- load_gcm(file.path(proj_dir, "MRI-CGCM3_rcp45_AET_annual_sum_burroughs.nc"))
cwd_warm_dry <- load_gcm(file.path(proj_dir, "MRI-CGCM3_rcp45_Deficit_annual_sum_burroughs.nc"))

aet_hot_dry <- load_gcm(file.path(proj_dir, "HadGEM2-CC365_rcp85_AET_annual_sum_burroughs.nc"))
cwd_hot_dry <- load_gcm(file.path(proj_dir, "HadGEM2-CC365_rcp85_Deficit_annual_sum_burroughs.nc"))

aet_warm_wet_plot <- ggplot() +
  geom_spatraster(data = clamp(aet_warm_wet, lower = 100, values = NA), alpha = 1) +
  aet_scale +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), fill = NA) +
  labs(title = "AET Warm-Wet (MRI-CGCM3 RCP8.5)", x = "", y = "") +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

cwd_warm_wet_plot <- ggplot() +
    geom_spatraster(data = clamp(cwd_warm_wet, lower = 100, values = NA), alpha = 1) +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "CWD Warm-Wet (MRI-CGCM3 RCP8.5)", x = "", y = "") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

aet_hot_wet_plot <- ggplot() +
    geom_spatraster(data = clamp(aet_hot_wet, lower = 100, values = NA), alpha = 1) +
    aet_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "AET Hot-Wet (CanESM2 RCP8.5)", x = "", y = "") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_hot_wet_plot <- ggplot() +
    geom_spatraster(data = clamp(cwd_hot_wet, lower = 100, values = NA), alpha = 1) +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "CWD Hot-Wet (CanESM2 RCP8.5)", x = "", y = "") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

aet_warm_dry_plot <- ggplot() +
    geom_spatraster(data = clamp(aet_warm_dry, lower = 100, values = NA), alpha = 1) +
    aet_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "AET Warm-Dry (MRI-CGCM3 RCP4.5)", x = "", y = "") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_warm_dry_plot <- ggplot() +
    geom_spatraster(data = clamp(cwd_warm_dry, lower = 100, values = NA), alpha = 1) +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "CWD Warm-Dry (MRI-CGCM3 RCP4.5)", x = "", y = "") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

aet_hot_dry_plot <- ggplot() +
    geom_spatraster(data = clamp(aet_hot_dry, lower = 100, values = NA), alpha = 1) +
    aet_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "CWD Hot-Dry (HadGEM2-CC365 RCP8.5)", x = "", y = "") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_hot_dry_plot <- ggplot() +
    geom_spatraster(data = clamp(cwd_hot_dry, lower = 100, values = NA), alpha = 1) +
    cwd_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "CWD Hot-Dry (HadGEM2-CC365 RCP8.5)", x = "", y = "") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


ggarrange(
    aet_warm_wet_plot, aet_hot_wet_plot,
    aet_warm_dry_plot, aet_hot_dry_plot,
    common.legend = TRUE
)

ggarrange(
    cwd_warm_wet_plot, cwd_hot_wet_plot,
    cwd_warm_dry_plot, cwd_hot_dry_plot,
    common.legend = TRUE
)

```

## Change from Baseline
Using historic (2002-2022) conditions as a baseline, we compare the RCP4.5 and RCP8.5 ensemble projections.  Units show mm in crease from baseline conditions.  These visualizations show areas which pixels are projected to change the most and least.  

``` {r cwd-baseline, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 16, out.width = '100%', fig.cap = "Ensemble mean CWD end-of-century (2075-2099) change from baseline (2002-2022)"}
cwd_rcp45_change_from_baseline <- cwd_ens45_end - cwd_2022

cwd_45_change_plot <- ggplot() +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    cwd_change_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

cwd_rcp85_change_from_baseline <- cwd_ens85_end - cwd_2022

cwd_85_change_plot <- ggplot() +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp85_change_from_baseline, alpha = 1) +
    cwd_change_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP8.5") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggarrange(cwd_45_change_plot, cwd_85_change_plot, common.legend = TRUE) %>%
    annotate_figure(top = text_grob("CWD change from baseline (2002-2022 to 2075-2099)", size = 14, face = "bold"))

```

``` {r aet-baseline, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 16, out.width = '100%', fig.cap = "Ensemble mean AET end-of-century (2075-2099) change from baseline (2002-2022)"}
## AET change from baseline

aet_rcp45_change_from_baseline <- aet_ens45_end - aet_2022

aet_45_change_plot <- ggplot() +
##    geom_spatraster(data = shade, show.legend = FALSE) +
##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = cwd_rcp45_change_from_baseline, alpha = 1) +
    aet_change_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP4.5") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))


aet_rcp85_change_from_baseline <- aet_ens85_end - aet_2022

aet_85_change_plot <- ggplot() +
    ##    geom_spatraster(data = shade, show.legend = FALSE) +
    ##    scale_fill_gradientn(colors = pal_greys, na.value = NA) +
    ggnewscale::new_scale_fill() +
    geom_spatraster(data = aet_rcp85_change_from_baseline, alpha = 1) +
    aet_change_scale +
    geom_sf(data = units, fill = NA, lwd = 1.5) +
    geom_sf_label(data = units, aes(label = Unit), fill = NA) +
    labs(title = "RCP8.5") +
    annotation_north_arrow(aes(location = "tr")) +
    annotation_scale(aes(location = "br"))

ggarrange(aet_45_change_plot, aet_85_change_plot, common.legend = TRUE) %>%
    annotate_figure(top = text_grob("AET change from baseline (2002-2022 to 2075-2099)", size = 14, face = "bold"))

```

## Best Planting Sites
An algorithm to select the "best" planting locations based on this
data is presented here.  The 1,000,000 pixels with the highest AET and
1,000,000 pixels with the lowest CWD are selected.  Pixels that
overlap between these layers are selected, giving pixels that maximize
AET and minimize CWD, and decreasing selected pixels to around 200,000
or approximately 10-15% of the landscape here.  
``` {r best-plantings, warning = FALSE, message = FALSE, echo = FALSE, fig.height = 20, fig.width = 10, out.width = '100%', fig.cap = "Locations that maximize AET and CWD for historical (2002-2022) and RCP4.5/RCP8.5 end-of-century projection ensembles.  n = number of pixels selected by algorithm, percentage shown is percentage of landscape identified by algorithm."}
n_sites <- 1000000

## (n_sites / ncell(elev)) * 100

highest_aet_historical <- selectHighest(aet_2022, n = n_sites)
lowest_cwd_historical <- selectHighest(cwd_2022, n = n_sites, low = TRUE)

best_sites_historical <- highest_aet_historical & lowest_cwd_historical

n_best_sites_historical <- zonal(best_sites_historical, best_sites_historical, length)[[2]]

## (n_best_sites / ncell(elev)) * 100

mean_aet_historical <- global(mask(aet_2022, highest_aet_historical), fun = "mean", na.rm = TRUE)
mean_cwd_historical <- global(mask(cwd_2022, lowest_cwd_historical), fun = "mean", na.rm = TRUE)

highest_aet_rcp45 <- selectHighest(aet_ens45_end, n = n_sites)
lowest_cwd_rcp45 <- selectHighest(cwd_ens45_end, n = n_sites, low = TRUE)

best_sites_rcp45 <- highest_aet_rcp45 & lowest_cwd_rcp45

n_best_sites_rcp45 <- zonal(best_sites_rcp45, best_sites_rcp45, length)[[2]]

## (n_best_sites / ncell(elev)) * 100

mean_aet_rcp45 <- global(mask(aet_ens45_end, highest_aet_rcp45), fun = "mean", na.rm = TRUE)
mean_cwd_rcp45 <- global(mask(cwd_ens45_end, lowest_cwd_rcp45), fun = "mean", na.rm = TRUE)


highest_aet_rcp85 <- selectHighest(aet_ens85_end, n = n_sites)
lowest_cwd_rcp85 <- selectHighest(cwd_ens85_end, n = n_sites, low = TRUE)

best_sites_rcp85 <- highest_aet_rcp85 & lowest_cwd_rcp85

n_best_sites_rcp85 <- zonal(best_sites_rcp85, best_sites_rcp85, length)[[2]]

## (n_best_sites / ncell(elev)) * 100

mean_aet_rcp85 <- global(mask(aet_ens85_end, highest_aet_rcp85), fun = "mean", na.rm = TRUE)
mean_cwd_rcp85 <- global(mask(cwd_ens85_end, lowest_cwd_rcp85), fun = "mean", na.rm = TRUE)


best_sites_historical_plot <- ggplot() +
  geom_spatraster(data = shade, show.legend = FALSE) +
  ##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
  scale_fill_gradientn(colors = pal_greys, na.value = NA) +
  ggnewscale::new_scale_fill() +
  geom_spatraster(data = best_sites_historical) +
  scale_fill_discrete(na.value = "transparent") +
  geom_sf(data = fs_roads, color = "orange", lwd = 1.5, alpha = 0.5) +
  geom_sf_text(data = fs_roads, aes(label = ID), alpha = 0.9) +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), alpha = 0.4) +
  labs(title = glue::glue("Historical (2002-2022), n = {n_best_sites_historical}, {round(n_best_sites_historical * 100 / ncell(elev), 2)}%")) +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

best_sites_rcp45_plot <- ggplot() +
  geom_spatraster(data = shade, show.legend = FALSE) +
  ##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
  scale_fill_gradientn(colors = pal_greys, na.value = NA) +
  ggnewscale::new_scale_fill() +
  geom_spatraster(data = best_sites_rcp45) +
  scale_fill_discrete(na.value = "transparent") +
  geom_sf(data = fs_roads, color = "orange", lwd = 1.5, alpha = 0.5) +
  geom_sf_text(data = fs_roads, aes(label = ID), alpha = 0.9) +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), alpha = 0.4) +
  labs(title = glue::glue("RCP4.5 End of Century n = {n_best_sites_rcp45}, {round(n_best_sites_rcp45 * 100 / ncell(elev), 2)}%")) +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

best_sites_rcp85_plot <- ggplot() +
  geom_spatraster(data = shade, show.legend = FALSE) +
  ##    geom_spatraster(data = subset(tmmn$daily_minimum_temperature, 1)) +
  scale_fill_gradientn(colors = pal_greys, na.value = NA) +
  ggnewscale::new_scale_fill() +
  geom_spatraster(data = best_sites_rcp85) +
  scale_fill_discrete(na.value = "transparent") +
  geom_sf(data = fs_roads, color = "orange", lwd = 1.5, alpha = 0.5) +
  geom_sf_text(data = fs_roads, aes(label = ID), alpha = 0.9) +
  geom_sf(data = units, fill = NA, lwd = 1.5) +
  geom_sf_label(data = units, aes(label = Unit), alpha = 0.4) +
  labs(title = glue::glue("RCP8.5 End of Century n = {n_best_sites_rcp85}, {round(n_best_sites_rcp85 * 100 / ncell(elev), 2)}%")) +
  annotation_north_arrow(aes(location = "tr")) +
  annotation_scale(aes(location = "br"))

## bind_cols(units,
##     sum_area_best_sites = zonal(best_sites, vect(units), fun = "sum", na.rm = TRUE)[[1]]
## ) %>%
##     as_tibble() %>%
##     select(Unit, sum_area_best_sites) %>%
##     knitr::kable(digits = 2)

ggarrange(best_sites_historical_plot, best_sites_rcp45_plot, best_sites_rcp85_plot,
    ncol = 1
) %>%
    annotate_figure(top = text_grob("Best Planting Sites", size = 14, face = "bold"))


```
This algorithm identifies areas of the landscape that are ideal based on the criteria of maximizing AET and minimizing CWD, relative to other pixels in the landscape for the same time period.  Much of the area identified by this algorithm in the based on conditions over the past twenty years is likely to remain the areas that maximize AET and minimize CWD under projected climatic conditions at the end of the century (Figure \@ref(fig:best-plantings)).  However, widespread warming under climate projections will also affect these areas, and they will likely experience increases in both annual AET and Deficit by the end of the century as will the rest of the landscape.  

Average conditions of "ideal pixels" (red pixels in Figure \@ref(fig:best-plantings)) in historic, RCP4.5 and RCP8.5 scenarios:

| Scenario | Mean AET                | Mean CWD                |
|----------|-------------------------|-------------------------|
| Historic | `r mean_aet_historical` | `r mean_cwd_historical` |
| RCP4.5   | `r mean_aet_rcp45`      | `r mean_cwd_rcp45`      |
| RCP8.5   | `r mean_aet_rcp85`      | `r mean_cwd_rcp85`      |


## Climate Summaries

Table: (\#tab:change-from-baseline-table) Change from AET and CWD baseline (2002-2022) in RCP4.5 and RCP8.5 ensembles
  
| Scenario | AET Mean change from 2002-2022 Baseline          | CWD Mean change from 2002-2022 Baseline          |
|----------|--------------------------------------------------|--------------------------------------------------|
| RCP4.5   | `r global(mean(aet_rcp45_change_from_baseline))` | `r global(mean(cwd_rcp45_change_from_baseline))` |
| RCP8.5   | `r global(mean(aet_rcp85_change_from_baseline))` | `r global(mean(cwd_rcp85_change_from_baseline))` |



Table: (\#tab:climate-summary) Summary of climate conditions for historic data and projections.

| Year                | Mean AET                         | Mean CWD                         |
|---------------------|----------------------------------|----------------------------------|
| 1988 (Drought Year) | `r global(mean(aet_1988))`       | `r global(mean(cwd_1988))`       |
| 1982-2002           | `r global(mean(aet_2002))`       | `r global(mean(cwd_2002))`       |
| 2002-2022           | `r global(mean(aet_2022))`       | `r global(mean(cwd_2022))`       |
| RCP4.5 near         | `r global(mean(aet_ens45_near))` | `r global(mean(cwd_ens45_near))` |
| RCP8.5 near         | `r global(mean(aet_ens85_near))` | `r global(mean(cwd_ens85_near))` |
| RCP4.5 mid          | `r global(mean(aet_ens45_mid))`  | `r global(mean(cwd_ens45_mid))`  |
| RCP8.5 mid          | `r global(mean(aet_ens85_mid))`  | `r global(mean(cwd_ens85_mid))`  |
| RCP4.5 end          | `r global(mean(aet_ens45_end))`  | `r global(mean(cwd_ens45_end))`  |
| RCP8.5 end          | `r global(mean(aet_ens85_end))`  | `r global(mean(cwd_ens85_end))`  |

# Limitations
Snow accumulation and melt were modeled at the scale of the entire
site, and was not downscaled based on topography.  In reality, snow
accumulation and melt is affected by factors such as slope, aspect, as
well as horizontal movement through snow drift.  Future analyses could
incorporate the high-resolution topographic data used here to improve
accuracy of snow melt and accumulation dynamics at fine scales.

Temperature and precipitation data were applied uniformly across all
pixels in the site.  However, temperature is affected by changes in
elevation and this can impact the accuracy of modeled water balance
metrics.  Future analyses could incorporate temperature corrections
based on lapse rate to improve accuracy of modeled metrics that are
temperature-sensitive [@tercekCorrectlyApplyingLapse2021].

Soil survey data provided by the SSURGO database is intended to be
used at scales of 1:24,000.  There is likely considerable variation in
the soil characteristics observed at the fine spatial scales analyzed
here that is not captured in these surveys.  Planting decisions made
using this data should consider observed soil characteristics in the
field in conjunction with data presented here.

# Discussion

The Burroughs Creek site presents opportunities to take advantage of
microsites created by the effects of local topographic and soil
features.

Extreme CWD is likely to threaten tree survival on the site in the
future.  In 1988, a year in which severe drought led to widespread
wildfire through the greater region, the Burroughs Creek site (defined
by the bounding box surrounding the two planting units) experienced an
average annual CWD of 269.93 mm (Table \@ref(tab:climate-summary)),
with some locations experiencing higher or lower deficit depending on
the effects of topoedaphic features (Figure
\@ref(fig:drought-year-plot)). Under the RCP8.5 scenario, the average
annual CWD will likely exceed this level, with a mean annual CWD of
306.32 mm projected averaged across all GCMs.  It is likely that
plants on the Burroughs Creek site will experience severe drought
stress in the future, leading to increase mortality as well as
likelihood of wildfire ignition [@thomaWaterBalanceIndicator2020].  To
maximize success of tree plantings on this site, planters can utilize
topoedaphic features to plant in locations that buffer from extreme
CWD, which will reduce tree stress and promote survival of planted
seedlings.  

Optimizing for AET in planting locations would increase seedling
growth rates and establishment
[@laufenbergBiophysicalGradientsPerformance2020]. In this landscape,
differences in AET appear to be mainly driven by differences in soil
WHC, which sustains evapotranspiration for longer in areas with higher
plant available water storage (Figures
\@ref(fig:historical-aet-plot),\@ref(fig:aet-projections)). North
facing slopes which reduce observed CWD also have the effect of
decreasing AET due to reduced incoming solar radiation.  Given the
extreme levels of CWD projected on this location, drought mortality in
planted trees is likely to be high and planters may wish to select
planting locations that minimize drought stress at the expense of
slower seedling growth rates.

Unit RL1 is mostly homogeneous in topoedaphic features, being
primarily an open face that is SE-facing and characterized by low to
moderate soil WHC for the area (Tables
\@ref(tab:planting-unit-statistics), \@ref(tab:soils-zonals)).
Planting microclimates in unit RL1 are likely to be similar throughout
the unit, however, some landscape features are present which could
create favorable planting microclimates such as the small hill in the
south section of the unit where the northern side of the hill appears
to buffer the location from extreme values of deficit (Figure
\@ref(fig:best-plantings)).

Unit WB2 is more diverse in soils and topography, with deeper soils
and more rugged terrain than unit RL1 (Tables
\@ref(tab:planting-unit-statistics), \@ref(tab:soils-zonals)).  This
creates a broader range of microclimates, with a broader range of
observed AET and CWD throughout the unit when compared to RL1 (Figures
\@ref(fig:historical-aet-plot), \@ref(fig:historical-cwd-plot),
\@ref(fig:drought-year-plot), \@ref(fig:cwd-projections),
\@ref(fig:aet-projections).  Undulations in terrain in this unit
create a variety of north to east facing slopes and shelves that can
create suitable microclimates for planting (Figure
\@ref(fig:best-plantings)), while more exposed locations with southern
aspects show some of the most extreme CWD values observed on the site
(Figure \@ref(fig:cwd-projections)).  These same areas that create
favorable conditions measured by annual AET and CWD also appear to
limit interannual variability in CWD projections (Figure
\@ref(fig:cwd-sd-plot)), promoting tree longevity, and minimize
change in CWD and AET from baseline conditions (Figures
\@ref(fig:aet-baseline) \@ref(fig:cwd-baseline)).  

Unit WB2 has large areas of more hydric soils with higher WHC present
at the bottom of drainages in the unit (Figure \@ref(fig:soils)). The
relatively higher soil WHC present in these soils has the effect of
increasing AET and decreasing CWD where they are present.  However,
these soils currently support riparian plant communities (soils
report), and are not likely to be locations that whitebark seedlings
could be competitive. Due to limitations in the available soil data,
these soils are treated as relatively discrete areas, however, in
reality there is likely to be considerable gradation between and
heterogeneity within soil types. Around the edges of these more hydric
soils, it is likely that locations can be found that have more plant
available water than would be expected based on this modeled data. *In
situ*, trees can also access features like subsurface flows and water
in bedrock [@mccormickWidespreadWoodyPlant2021], which is not
accounted for in this model.

A large portion of the area that was identified as optimal for
planting (Figure \@ref(fig:best-plantings)) is present outside of the
two planting units. Satellite imagery shows existing tree cover in
most of the area outside of the planting unit boundaries.  However, if
planting materials are available and openings exist in some of the
areas, planters may wish to plant outside of the boundaries where
suitable planting microclimates exist.

<!-- # TODO -->

<!-- - 3d Maps -->
<!-- - Other ways to identify ideal planting locations.  What criteria are Nancy/planting crews looking for? -->

# Acknowledgments
Computational efforts were performed on the [Tempest High Performance
Computing System](https://www.montana.edu/uit/rci/tempest/), operated and supported by University Information
Technology Research Cyberinfrastructure at Montana State University.

# References

<!-- Local Variables: -->
<!-- jinx-local-words: "ncell" -->
<!-- End: -->
